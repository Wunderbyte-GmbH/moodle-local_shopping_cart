define("local_shopping_cart/checkout_manager",["exports","core/modal_factory","core/str","local_shopping_cart/cart"],(function(_exports,_modal_factory,_str,_cart){var obj;
/*
   * @package    local_shopping_cart
   * @copyright  Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.getChangedInputs=getChangedInputs,_exports.getDatasetValue=getDatasetValue,_exports.init=function(){(function(formBody){initControlListener(),null!=formBody&&(function(){const formBody=document.querySelector(SELECTORS_CHECKBOXITEMBODY);formBody.addEventListener("change",(event=>function(event,formBody){const target=event.target;if(["INPUT","SELECT","TEXTAREA"].includes(target.tagName)){const changedInputs=getChangedInputs();if(target.hasAttribute("data-skip-webservice"))return;"checkbox"==target.type&&(target.value=target.checked),triggerButtonControlWebService(WEBSERVICE_CHECKOUTPROCESS,{action:getDatasetValue(formBody,"action"),currentstep:getDatasetValue(formBody,"currentstep"),identifier:getDatasetValue(formBody,"identifier"),changedinput:JSON.stringify(changedInputs)})}}(event,formBody)))}(),function(){const vatNumber=document.getElementById(IDS_VERIFYVAT);vatNumber&&vatNumber.addEventListener("click",vatNumberVerifyCallback)}())})(document.querySelector(SELECTORS_CHECKBOXITEMBODY)),document.addEventListener(EVENTSLISTENING_ADDRESSREDRAWN,getNewAddress)},_modal_factory=(obj=_modal_factory)&&obj.__esModule?obj:{default:obj};const SELECTORS_CHECKOUTMANAGERFORMID="#shopping-cart-checkout-manager-form",SELECTORS_CHECKOUTMANAGERFORMTEMPLATE="local_shopping_cart/checkout_manager_form",SELECTORS_CHECKOUTMANAGERBUTTONSTEMPLATE="local_shopping_cart/checkout_manager_form_buttons",SELECTORS_CHECKOUTMANAGERBUTTONSID="shopping-cart-checkout-manager-buttons",SELECTORS_CHECKOUTMANAGERPROGRESSBARTEMPLATE="local_shopping_cart/checkout_manager_form_progress_bar",SELECTORS_CHECKOUTMANAGERPROGRESSBARID="shopping-cart-checkout-manager-status-bar",SELECTORS_BUTTONS=".shopping-cart-checkout-manager-buttons button",SELECTORS_PROGRESSBUTTONS=".shopping-cart-checkout-manager-status-bar button",SELECTORS_CHECKBOXITEMBODY="#shopping-cart-checkout-manager-form-body",SELECTORS_FEEDBACKMESSAGE=".shopping-cart-checkout-manager-alert-container",SELECTORS_PAYMENTREGIONBUTTON="div.shopping_cart_payment_region button",WEBSERVICE_CHECKOUTPROCESS="local_shopping_cart_control_checkout_process",EVENTSLISTENING_ADDRESSREDRAWN="local_shopping_cart/addressesRedrawn",IDS_VATNUMBER="shopping-cart-checkout-manager-vat-number",IDS_VERIFYVAT="shopping-cart-checkout-manager-verify-vat",IDS_COUNTRYSELECT="shopping-cart-checkout-manager-country-select";function getNewAddress(){const currentstep=getDatasetValue(document.querySelector(SELECTORS_CHECKBOXITEMBODY),"currentstep");null!==currentstep&&triggerButtonControlWebService(WEBSERVICE_CHECKOUTPROCESS,{action:"",currentstep:currentstep})}function vatNumberVerifyCallback(){var _document$getElementB,_document$getElementB2;const formBody=document.querySelector(SELECTORS_CHECKBOXITEMBODY),countryCode=null===(_document$getElementB=document.getElementById(IDS_COUNTRYSELECT))||void 0===_document$getElementB?void 0:_document$getElementB.value,vatNumber=null===(_document$getElementB2=document.getElementById(IDS_VATNUMBER))||void 0===_document$getElementB2?void 0:_document$getElementB2.value;countryCode&&vatNumber?triggerButtonControlWebService(WEBSERVICE_CHECKOUTPROCESS,{action:getDatasetValue(formBody,"action"),currentstep:getDatasetValue(formBody,"currentstep"),identifier:getDatasetValue(formBody,"identifier"),changedinput:JSON.stringify({vatCodeCountry:`${countryCode},${vatNumber}`})}):_modal_factory.default.create({type:_modal_factory.default.types.CANCEL}).then((modal=>(modal.setTitle((0,_str.get_string)("errorinvalidvatdatatitle","local_shopping_cart")),modal.setBody((0,_str.get_string)("errorinvalidvatdatadescription","local_shopping_cart")),modal.show(),modal))).catch((e=>{console.log(e)}))}function initControlListener(){const selectors=`${SELECTORS_BUTTONS}, ${SELECTORS_PROGRESSBUTTONS}`;document.querySelectorAll(selectors).forEach((button=>{button.addEventListener("click",controlCallback)}))}function controlCallback(){const action=this.getAttribute("data-action"),currentstep=this.getAttribute("data-currentstep");action&&currentstep&&triggerButtonControlWebService(WEBSERVICE_CHECKOUTPROCESS,{action:action,currentstep:currentstep})}function getChangedInputs(){const processElements=document.querySelectorAll('[data-shopping-cart-process-data="true"]');return Array.from(processElements).map((element=>{const value="checkbox"===element.type?element.checked:element.value;return"radio"===element.type?element.checked?{name:element.name||"unnamed",value:value}:[]:{name:element.name||"unnamed",value:value}})).filter((item=>null!==item))}function triggerButtonControlWebService(serviceName,params){require(["core/ajax"],(function(Ajax){Ajax.call([{methodname:serviceName,args:params}])[0].done((function(response){var data;(data=response).data=JSON.parse(data.data),require(["core/templates"],(function(templates){data.reloadbody?function(templates,data){templates.render(SELECTORS_CHECKOUTMANAGERFORMTEMPLATE,data.data).then((function(html,js){return templates.replaceNodeContents(document.querySelector(SELECTORS_CHECKOUTMANAGERFORMID),html,js)})).then((function(){if(data.jsscript){const scriptContent=data.jsscript.replace(/<script[^>]*>|<\/script>/gi,"");try{templates.appendNodeContents(document.querySelector(SELECTORS_CHECKOUTMANAGERFORMID),"",scriptContent)}catch(err){console.error("fail script",err)}callZeroPriceListener()}})).catch((function(err){console.error("fail script",err)}))}(templates,data):function(templates,data){const controlButtons=document.getElementById(SELECTORS_CHECKOUTMANAGERBUTTONSID),progressBar=document.getElementById(SELECTORS_CHECKOUTMANAGERPROGRESSBARID),feedbackMessageContainer=document.querySelector(SELECTORS_FEEDBACKMESSAGE);if(!controlButtons)return void console.error("controlButtons");const renderButtonTemplate=templates.render(SELECTORS_CHECKOUTMANAGERBUTTONSTEMPLATE,data.data).then((function(html){controlButtons.innerHTML=html})).catch((function(err){console.error("fail render button",err)})),progressBarTemplate=templates.render(SELECTORS_CHECKOUTMANAGERPROGRESSBARTEMPLATE,data.data).then((function(html){progressBar.innerHTML=html})).catch((function(err){console.error("fail render button",err)}));if(feedbackMessageContainer){const datafeedback=JSON.parse(data.managerdata);feedbackMessageContainer&&null!=datafeedback.feedback&&templates.render("local_shopping_cart/checkout_manager_feedback",datafeedback.feedback).then((function(html){feedbackMessageContainer.innerHTML=html})).catch((function(err){console.error("fail render feedback",err)}))}Promise.all([renderButtonTemplate,progressBarTemplate]).then((function(){initControlListener(),callZeroPriceListener()})).catch((function(err){console.error("fail init listener",err)}))}(templates,data)}))})).fail((function(err){console.error("fail button trigger",err)}))}))}function getDatasetValue(element,key){return(null==element?void 0:element.dataset[key])||""}function callZeroPriceListener(){document.querySelector(SELECTORS_PAYMENTREGIONBUTTON)&&(0,_cart.reinit)()}}));

//# sourceMappingURL=checkout_manager.min.js.map