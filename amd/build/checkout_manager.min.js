define("local_shopping_cart/checkout_manager",["exports"],(function(_exports){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.getChangedInputs=getChangedInputs,_exports.getDatasetValue=getDatasetValue,_exports.init=function(){(function(formBody){initControlListener(),null!=formBody&&(function(){const formBody=document.querySelector(SELECTORS.CHECKBOXITEMBODY);formBody.addEventListener("change",(event=>function(event,formBody){const target=event.target;if(["INPUT","SELECT","TEXTAREA"].includes(target.tagName)){const changedInputs=getChangedInputs();if(target.hasAttribute("data-skip-webservice"))return;"checkbox"==target.type&&(target.value=target.checked),triggerButtonControlWebService(WEBSERVICE.CHECKOUTPROCESS,{action:getDatasetValue(formBody,"action"),currentstep:getDatasetValue(formBody,"currentstep"),identifier:getDatasetValue(formBody,"identifier"),changedinput:JSON.stringify(changedInputs)})}}(event,formBody)))}(),function(){const vatNumber=document.getElementById(IDS.VERIFYVAT);vatNumber&&vatNumber.addEventListener("click",vatNumberVerifyCallback)}())})(document.querySelector(SELECTORS.CHECKBOXITEMBODY)),document.addEventListener(EVENTSLISTENING.ADDRESSREDRAWN,getNewAddress)};
/*
   * @package    local_shopping_cart
   * @copyright  Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */
const SELECTORS={CHECKOUTMANAGERFORMID:"#shopping-cart-checkout-manager-form",CHECKOUTMANAGERFORMTEMPLATE:"local_shopping_cart/checkout_manager_form",CHECKOUTMANAGERBUTTONSTEMPLATE:"local_shopping_cart/checkout_manager_form_buttons",CHECKOUTMANAGERBUTTONSID:"shopping-cart-checkout-manager-buttons",CHECKOUTMANAGERPROGRESSBARTEMPLATE:"local_shopping_cart/checkout_manager_form_progress_bar",CHECKOUTMANAGERPROGRESSBARID:"shopping-cart-checkout-manager-status-bar",BUTTONS:".shopping-cart-checkout-manager-buttons button",PROGRESSBUTTONS:".shopping-cart-checkout-manager-status-bar button",CHECKBOXITEMBODY:"#shopping-cart-checkout-manager-form-body",NEWADDRESSBUTTON:".shopping-cart-new-address",FEEDBACKMESSAGE:".shopping-cart-checkout-manager-alert-container"},WEBSERVICE={CHECKOUTPROCESS:"local_shopping_cart_control_checkout_process"},EVENTSLISTENING={ADDRESSREDRAWN:"local_shopping_cart/addressesRedrawn"},IDS={VATNUMBER:"shopping-cart-checkout-manager-vat-number",VERIFYVAT:"shopping-cart-checkout-manager-verify-vat",COUNTRYSELECT:"shopping-cart-checkout-manager-country-select"};function getNewAddress(){const currentstep=getDatasetValue(document.querySelector(SELECTORS.CHECKBOXITEMBODY),"currentstep");null!==currentstep&&triggerButtonControlWebService(WEBSERVICE.CHECKOUTPROCESS,{action:"",currentstep:currentstep})}function vatNumberVerifyCallback(){const formBody=document.querySelector(SELECTORS.CHECKBOXITEMBODY),countryCode=document.getElementById(IDS.COUNTRYSELECT)?.value,vatNumber=document.getElementById(IDS.VATNUMBER)?.value;countryCode&&vatNumber?triggerButtonControlWebService(WEBSERVICE.CHECKOUTPROCESS,{action:getDatasetValue(formBody,"action"),currentstep:getDatasetValue(formBody,"currentstep"),identifier:getDatasetValue(formBody,"identifier"),changedinput:JSON.stringify({vatCodeCountry:`${countryCode},${vatNumber}`})}):alert("alert")}function initControlListener(){const selectors=`${SELECTORS.BUTTONS}, ${SELECTORS.PROGRESSBUTTONS}`;document.querySelectorAll(selectors).forEach((button=>{button.addEventListener("click",controlCallback)}))}function controlCallback(){const action=this.getAttribute("data-action"),currentstep=this.getAttribute("data-currentstep");action&&currentstep&&triggerButtonControlWebService(WEBSERVICE.CHECKOUTPROCESS,{action:action,currentstep:currentstep})}function getChangedInputs(){const processElements=document.querySelectorAll('[data-shopping-cart-process-data="true"]');return Array.from(processElements).map((element=>{const value="checkbox"===element.type?element.checked:element.value;return"radio"===element.type?element.checked?{name:element.name||"unnamed",value:value}:[]:{name:element.name||"unnamed",value:value}})).filter((item=>null!==item))}function triggerButtonControlWebService(serviceName,params){require(["core/ajax"],(function(Ajax){Ajax.call([{methodname:serviceName,args:params}])[0].done((function(response){var data;(data=response).data=JSON.parse(data.data),require(["core/templates"],(function(templates){data.reloadbody?function(templates,data){templates.render(SELECTORS.CHECKOUTMANAGERFORMTEMPLATE,data.data).then((function(html,js){return templates.replaceNodeContents(document.querySelector(SELECTORS.CHECKOUTMANAGERFORMID),html,js)})).then((function(){if(data.jsscript){const scriptContent=data.jsscript.replace(/<script[^>]*>|<\/script>/gi,"");try{templates.appendNodeContents(document.querySelector(SELECTORS.CHECKOUTMANAGERFORMID),"",scriptContent)}catch(err){console.error("fail script",err)}}})).catch((function(err){console.error("fail script",err)}))}(templates,data):function(templates,data){const controlButtons=document.getElementById(SELECTORS.CHECKOUTMANAGERBUTTONSID),progressBar=document.getElementById(SELECTORS.CHECKOUTMANAGERPROGRESSBARID),feedbackMessageContainer=document.querySelector(SELECTORS.FEEDBACKMESSAGE);if(!controlButtons)return void console.error("controlButtons");const renderButtonTemplate=templates.render(SELECTORS.CHECKOUTMANAGERBUTTONSTEMPLATE,data.data).then((function(html){controlButtons.innerHTML=html})).catch((function(err){console.error("fail render button",err)})),progressBarTemplate=templates.render(SELECTORS.CHECKOUTMANAGERPROGRESSBARTEMPLATE,data.data).then((function(html){progressBar.innerHTML=html})).catch((function(err){console.error("fail render button",err)}));if(feedbackMessageContainer){const datafeedback=JSON.parse(data.managerdata);feedbackMessageContainer&&null!=datafeedback.feedback&&templates.render("local_shopping_cart/checkout_manager_feedback",datafeedback.feedback).then((function(html){feedbackMessageContainer.innerHTML=html})).catch((function(err){console.error("fail render feedback",err)}))}Promise.all([renderButtonTemplate,progressBarTemplate]).then((function(){initControlListener()})).catch((function(err){console.error("fail init listener",err)}))}(templates,data)}))})).fail((function(err){console.error("fail button trigger",err)}))}))}function getDatasetValue(element,key){return element?.dataset[key]||""}}));

//# sourceMappingURL=checkout_manager.min.js.map