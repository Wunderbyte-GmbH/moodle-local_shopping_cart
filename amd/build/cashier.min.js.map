{"version":3,"file":"cashier.min.js","sources":["../src/cashier.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @package    local_shopping_cart\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Url from 'core/url';\n\nexport const init = (users, userid = 0) => {\n    // eslint-disable-next-line no-console\n    console.log('run init', userid);\n\n    document.getElementById('checkout-tab').classList.remove('success');\n\n    const buybuttons = document.querySelectorAll('.buy-btn');\n        // eslint-disable-next-line no-console\n        if (buybuttons) {\n            buybuttons.forEach(buybutton => {\n                buybutton.addEventListener('click', (e) => confirmPayment(userid, e.target.dataset.paymenttype));\n            });\n        }\n\n    const checkoutbutton = document.querySelector('#checkout-btn');\n    // eslint-disable-next-line no-console\n    console.log(checkoutbutton);\n    if (checkoutbutton) {\n        checkoutbutton.addEventListener('click', function() {\n\n            document.getElementById('checkout-tab').classList.add('success');\n            // eslint-disable-next-line no-console\n            console.log('click');\n        });\n    }\n\n    autocomplete(document.getElementById(\"searchuser\"), users);\n    attachFilterFuntion();\n\n     /**\n      * Attach filter function.\n      */\n    function attachFilterFuntion() {\n        const input = document.querySelector(\"#shoppingcartfilterinput\");\n        input.addEventListener(\"keyup\", () => {\n            const filter = input.value.toUpperCase();\n            const li = document.querySelectorAll(\".list-group-item.wunderbyteTableJavascript\");\n            for (let i = 0; i < li.length; i++) {\n                const a = li[i];\n                const txtValue = a.textContent || a.innerText;\n                if (txtValue.toUpperCase().indexOf(filter) > -1) {\n                    li[i].style.display = \"\";\n                } else {\n                    li[i].style.display = \"none\";\n                }\n            }\n        });\n    }\n};\n\nexport const confirmPayment = (userid, paymenttype) => {\n    Ajax.call([{\n        methodname: \"local_shopping_cart_confirm_cash_payment\",\n        args: {\n            'userid': userid,\n            'paymenttype': paymenttype\n        },\n        done: function(data) {\n            if (data.status == 1) {\n                // eslint-disable-next-line no-console\n                console.log('payment confirmed', data);\n\n                // The function can be called via cashier, or because a user pays via credits.\n                // If that's the case, we are not on the cashier site.\n\n                const oncashier = window.location.href.indexOf(\"cashier.php\");\n\n                // Set link to right receipt.\n                addPrintIdentifier(data.identifier, userid);\n\n                // If we are not on cashier, we can just redirect.\n                if (oncashier < 1) {\n\n                    const identifier = data.identifier;\n\n                    const newurl = Url.fileUrl(\"/local/shopping_cart/checkout.php?success=1&identifier=\" + identifier, \"\");\n\n                    location.href = newurl;\n\n                } else {\n                    document.getElementById('success-tab').classList.add('success');\n\n                    if (data.credit) {\n                        const credittotal = document.querySelector('span.credit_total');\n                        credittotal.innerText = data.credit;\n                    }\n\n                    // We might display the item more often than once.\n                    let items = document.querySelectorAll('#shopping_cart-cashiers-cart ul.shopping-cart-items li.clearfix');\n\n                    items.forEach(item => {\n                        // eslint-disable-next-line no-console\n                        console.log(item);\n                        if (item) {\n                            item.remove();\n                        }\n                    });\n                    let totalprices = document.querySelectorAll('#shopping_cart-cashiers-cart .initialtotal');\n\n                    totalprices.forEach(item => {\n                        // eslint-disable-next-line no-console\n                        console.log(item);\n                        if (item) {\n                            item.innerText = 0;\n                        }\n                    });\n                }\n\n            } else {\n                // eslint-disable-next-line no-console\n                console.log('payment denied');\n                document.getElementById('success-tab').classList.add('error');\n            }\n        },\n        fail: function(ex) {\n            // eslint-disable-next-line no-console\n            console.log(ex);\n        },\n    }]);\n};\n\nexport const validateCart = ($userid) => {\n    // eslint-disable-next-line no-alert\n    alert($userid);\n };\n\n/**\n * Adds parameters to the printbutton.\n * @param {int} identifier\n * @param {int} userid\n */\nexport const addPrintIdentifier = (identifier, userid) => {\n   let printbtn = document.getElementById('printbtn');\n   let href = printbtn.getAttribute('href');\n   printbtn.setAttribute('href', href + identifier + '&userid=' + userid);\n};\n\n/**\n * The autocomplete function takes two arguments.\n * The text field element and an array of possible autocompleted values.\n * @param {string} inp\n * @param {array} arr\n */\n export const autocomplete = (inp, arr) => {\n    var currentFocus;\n    const useridfield = document.querySelector('#useridfield');\n    inp.addEventListener(\"input\", function() {\n        var a, b, i;\n        let val = this.value;\n        closeAllLists();\n        if (!val) {\n            return false;\n        }\n        currentFocus = -1;\n        a = document.createElement(\"DIV\");\n        a.setAttribute(\"id\", this.id + \"autocomplete-list\");\n        a.setAttribute(\"class\", \"autocomplete-items\");\n        this.parentNode.appendChild(a);\n        for (i = 0; i < arr.length; i++) {\n            if (arr[i].toUpperCase().indexOf(val.toUpperCase()) > -1) {\n                /* Create a DIV element for each matching element: */\n                b = document.createElement(\"DIV\");\n                /* Make the matching letters bold: */\n                let index = arr[i].toUpperCase().indexOf(val.toUpperCase());\n                b.innerHTML = arr[i].substr(0, index);\n                b.innerHTML += \"<strong>\"\n                        + arr[i].substr(arr[i].toUpperCase().indexOf(val.toUpperCase()), val.length) + \"</strong>\";\n                b.innerHTML += arr[i].substr(index + val.length);\n                /* Insert a input field that will hold the current array item's value: */\n                b.innerHTML += \"<input type='hidden' value='\" + arr[i] + \"'>\";\n                b.addEventListener(\"click\", function() {\n                    inp.value = this.getElementsByTagName(\"input\")[0].value;\n                    useridfield.value = this.getElementsByTagName(\"input\")[0].value.split('uid:')[1];\n                    closeAllLists();\n                });\n                a.appendChild(b);\n            }\n        }\n        return null;\n    });\n\n    inp.addEventListener(\"keydown\", function(e) {\n        var x = document.getElementById(this.id + \"autocomplete-list\");\n        if (x) {\n            x = x.getElementsByTagName(\"div\");\n        }\n        if (e.keyCode == 40) {\n          currentFocus++;\n          addActive(x);\n        } else if (e.keyCode == 38) {\n          currentFocus--;\n          addActive(x);\n        } else if (e.keyCode == 13) {\n          e.preventDefault();\n          if (currentFocus > -1) {\n            if (x) {\n                x[currentFocus].click();\n            }\n          }\n        }\n    });\n\n    /**\n     * Add active.\n     * @param {*} x\n     */\n    function addActive(x) {\n        if (!x) {\n            return;\n        }\n        removeActive(x);\n        if (currentFocus >= x.length) {\n            currentFocus = 0;\n        }\n        if (currentFocus < 0) {\n            currentFocus = (x.length - 1);\n        }\n        x[currentFocus].classList.add(\"autocomplete-active\");\n    }\n\n    /**\n     * Remove active.\n     * @param {*} x\n     */\n    function removeActive(x) {\n        for (var i = 0; i < x.length; i++) {\n            x[i].classList.remove(\"autocomplete-active\");\n        }\n    }\n\n    /**\n     * Close all list elements.\n     * @param {*} elmnt\n     */\n    function closeAllLists(elmnt) {\n        var x = document.getElementsByClassName(\"autocomplete-items\");\n        for (var i = 0; i < x.length; i++) {\n            if (elmnt != x[i] && elmnt != inp) {\n            x[i].parentNode.removeChild(x[i]);\n            }\n        }\n    }\n    document.addEventListener(\"click\", function(e) {\n        closeAllLists(e.target);\n    });\n  };\n"],"names":["users","userid","console","log","document","getElementById","classList","remove","buybuttons","querySelectorAll","forEach","buybutton","addEventListener","e","confirmPayment","target","dataset","paymenttype","checkoutbutton","querySelector","attachFilterFuntion","input","filter","value","toUpperCase","li","i","length","a","textContent","innerText","indexOf","style","display","add","autocomplete","call","methodname","args","done","data","status","oncashier","window","location","href","addPrintIdentifier","identifier","newurl","Url","fileUrl","credit","item","fail","ex","$userid","alert","printbtn","getAttribute","setAttribute","inp","arr","currentFocus","useridfield","addActive","x","removeActive","closeAllLists","elmnt","getElementsByClassName","parentNode","removeChild","b","val","this","createElement","id","appendChild","index","innerHTML","substr","getElementsByTagName","split","keyCode","preventDefault","click"],"mappings":"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"}