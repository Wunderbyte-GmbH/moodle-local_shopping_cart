define("local_shopping_cart/cart",["exports","core/ajax","core/templates","core/modal_factory","core/modal_events","local_shopping_cart/cashier","local_shopping_cart/notifications","core/str"],(function(_exports,_ajax,_templates,_modal_factory,_modal_events,_cashier,_notifications,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * @package    local_shopping_cart
   * @copyright  Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=_exports.deleteItem=_exports.deleteAllItems=_exports.buttoninit=_exports.addItem=void 0,_exports.initPriceLabel=function(userid){userid<1&&(userid=0);const checkbox=document.querySelector(SELECTORS_PRICELABELCHECKBOX);checkbox&&checkbox.addEventListener("change",(event=>{console.log(event),event.currentTarget.checked?updateTotalPrice(userid,!0):updateTotalPrice(userid,!1)}))},_exports.visbilityevent=_exports.updateTotalPrice=_exports.reinit=_exports.interval=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events);var interval=null;_exports.interval=interval;var visbilityevent=!1;_exports.visbilityevent=visbilityevent;const SELECTORS_SHOPPING_CART_ITEM='[data-item="shopping_cart_item"]',SELECTORS_NAVBARCONTAINER="#nav-shopping_cart-popover-container .shopping-cart-items-container",SELECTORS_TRASHCLASS="fa-trash-o",SELECTORS_BADGECOUNT="#nav-shopping_cart-popover-container div.count-container",SELECTORS_COUNTDOWN="#nav-shopping_cart-popover-container span.expirationdate",SELECTORS_CASHIERSCART="#shopping_cart-cashiers-cart",SELECTORS_CHECKOUTCART="div.shopping-cart-checkout-items-container",SELECTORS_PRICELABELCHECKBOX=".sc_price_label input.usecredit-checkbox",SELECTORS_PRICELABELAREA=".sc_price_label",buttoninit=(itemid,component)=>{document.querySelectorAll('button[data-itemid="'+itemid+'"][data-component="'+component+'"][data-objecttable="local_shopping_cart"').forEach((addtocartbutton=>{toggleActiveButtonState(addtocartbutton),addtocartbutton&&"true"!==addtocartbutton.dataset.initialized&&(addtocartbutton.dataset.initialized="true",addtocartbutton.addEventListener("click",(event=>{addtocartbutton.classList.contains("disabled")||(event.preventDefault(),event.stopPropagation(),addItem(itemid,component))})))}))};_exports.buttoninit=buttoninit;_exports.init=expirationdate=>{let containers=[];containers.push(document.querySelector(SELECTORS_NAVBARCONTAINER)),containers.push(document.querySelector(SELECTORS_CHECKOUTCART)),containers.filter((x=>null!==x)).forEach((container=>{container.addEventListener("click",(event=>{const element=event.target;if(element.classList.contains(SELECTORS_TRASHCLASS)){const userid=element.dataset.userid?element.dataset.userid:0,component=element.dataset.component,itemid=element.dataset.itemid;deleteItem(itemid,component,userid)}}))})),0==visbilityevent&&document.addEventListener("visibilitychange",(function(){_exports.visbilityevent=visbilityevent=!0,"visible"===document.visibilityState&&reinit()}))};const reinit=function(){let userid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;console.log("reinit",userid),_ajax.default.call([{methodname:"local_shopping_cart_get_shopping_cart_items",args:{userid:userid},done:function(data){let promises=[];promises.push(_templates.default.renderForPromise("local_shopping_cart/shopping_cart_items",data).then((_ref=>{let{html:html,js:js}=_ref;return _templates.default.replaceNodeContents(SELECTORS_NAVBARCONTAINER,html,js),!0})).catch((e=>{console.log(e)}))),promises.push(_templates.default.renderForPromise("local_shopping_cart/shopping_cart_items",data).then((_ref2=>{let{html:html,js:js}=_ref2;return _templates.default.replaceNodeContents(SELECTORS_CHECKOUTCART,html,js),!0})).catch((e=>{console.log(e)}))),Promise.all(promises).then((()=>{clearInterval(interval),initTimer(data.expirationdate),updateBadge(data.count),toggleActiveButtonState(),updateTotalPrice(userid)})).catch((e=>{console.log(e)}))},fail:ex=>{console.log("ex:"+ex)}}])};_exports.reinit=reinit;const deleteAllItems=()=>{_ajax.default.call([{methodname:"local_shopping_cart_delete_all_items_from_cart",args:{},done:function(){document.querySelectorAll(SELECTORS_SHOPPING_CART_ITEM).forEach((item=>{item&&item.remove()})),updateTotalPrice();let itemcount1=document.getElementById("countbadge"),itemcount2=document.getElementById("itemcount");itemcount1.innerHTML=0,itemcount2.innerHTML=0,itemcount2.classList.add("hidden");document.querySelectorAll("[id^=btn-].disabled").forEach((btn=>{btn&&btn.classList.remove("disabled")}))},fail:function(ex){console.log(ex)}}])};_exports.deleteAllItems=deleteAllItems;const deleteItem=(itemid,component,userid)=>{_ajax.default.call([{methodname:"local_shopping_cart_delete_item",args:{itemid:itemid,component:component,userid:userid},done:function(){reinit(itemid,component)},fail:function(){reinit()}}])};_exports.deleteItem=deleteItem;const addItem=(itemid,component)=>{let userid=0;window.location.href.indexOf("cashier.php")>0&&(userid=-1),_ajax.default.call([{methodname:"local_shopping_cart_add_item",args:{component:component,itemid:itemid,userid:userid},done:function(data){if(data.component=component,data.itemid=itemid,data.userid=data.buyforuser,1==data.success){if(1==data.success){(0,_notifications.showNotification)(data.itemname+" added to cart","success");window.location.href.indexOf("cashier.php")&&(data.iscashier=!0),reinit(itemid,component)}}else(0,_notifications.showNotification)("Cart is full","danger")},fail:function(ex){console.log("error",ex)}}],!0)};_exports.addItem=addItem;const updateTotalPrice=function(){let userid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,usecredit=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];console.log("updatetotalprice");const checkbox=document.querySelector(SELECTORS_PRICELABELCHECKBOX);console.log("checked",checkbox.checked,usecredit),usecredit=usecredit?1:0,console.log("usecredit before ajax",usecredit),_ajax.default.call([{methodname:"local_shopping_cart_get_price",args:{userid:userid,usecredit:usecredit},done:function(data){1==data.usecredit?data.usecreditvalue="checked":data.usecreditvalue="",console.log(data,data.usecreditvalue),data.checkboxid=Math.random().toString(36).slice(2,5);const labelareas=document.querySelectorAll(SELECTORS_PRICELABELAREA);console.log(labelareas),_templates.default.renderForPromise("local_shopping_cart/price_label",data).then((_ref3=>{let{html:html,js:js}=_ref3;return _templates.default.replaceNodeContents(SELECTORS_PRICELABELAREA,html,js),!0})).catch((e=>{console.log(e)}));let paymentbutton=document.querySelector(".shopping_cart_payment_region button");if(paymentbutton){const price=data.price,currency=data.currency;console.log("paymentbutton",price,currency),paymentbutton.dataset.cost=price+" "+currency,0==price?(console.log("price is 0"),paymentbutton.addEventListener("click",dealWithZeroPrice)):(console.log("price is not 0"),paymentbutton.removeEventListener("click",dealWithZeroPrice))}},fail:function(ex){console.log("error",ex)}}],!0)};function dealWithZeroPrice(event){var element;console.log("onlymyclickcounts"),event.stopPropagation(),event.preventDefault(),console.log("onlymyclickcounts",event.target),element=event.target,(0,_str.get_strings)([{key:"confirmzeropricecheckouttitle",component:"local_shopping_cart"},{key:"confirmzeropricecheckoutbody",component:"local_shopping_cart"},{key:"confirmzeropricecheckout",component:"local_shopping_cart"}]).then((strings=>(_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL}).then((modal=>(modal.setTitle(strings[0]),modal.setBody(strings[1]),modal.setSaveButtonText(strings[2]),modal.getRoot().on(_modal_events.default.save,(function(){const userid=element.dataset.userid;console.log(userid),userid&&(0,_cashier.confirmPayment)(userid)})),modal.show(),modal))).catch((e=>{console.log(e)})),!0))).catch((e=>{console.log(e)}))}function startTimer(duration,display){var minutes,seconds,timer=duration;_exports.interval=interval=setInterval((function(){minutes=parseInt(timer/60,10),seconds=parseInt(timer%60,10),minutes=minutes<10?"0"+minutes:minutes,seconds=seconds<10?"0"+seconds:seconds,display.textContent=minutes+":"+seconds,--timer<0&&(deleteAllItems(),clearInterval(interval))}),1e3)}function initTimer(){let expirationdate=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const countdownelement=document.querySelector(SELECTORS_COUNTDOWN);interval&&clearInterval(interval);let delta=0,now=Date.now("UTC");now=(new Date).getTime()/1e3,expirationdate&&(delta=expirationdate-now),delta<=0?(delta=0,countdownelement.classList.add("hidden")):delta>0&&(countdownelement.classList.remove("hidden"),startTimer(delta,countdownelement))}function updateBadge(count){const badge=document.querySelector(SELECTORS_BADGECOUNT);count>0?(badge.innerHTML=count,badge.classList.remove("hidden")):(badge.innerHTML=count,badge.classList.add("hidden"))}function toggleActiveButtonState(){let button=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;console.log("toggleActiveButtonState");let selector="",component=null,itemid=null;button?(itemid=button.dataset.itemid,component=button.dataset.component,selector='button[data-itemid="'+itemid+'"][data-component="'+component+'"][data-objecttable="local_shopping_cart"'):selector='button[data-objecttable="local_shopping_cart"';const buttons=document.querySelectorAll(selector);let shoppingcart=document.querySelector(SELECTORS_CASHIERSCART);shoppingcart||(shoppingcart=document.querySelector(SELECTORS_NAVBARCONTAINER)),buttons.forEach((addtocartbutton=>{component=addtocartbutton.dataset.component,itemid=addtocartbutton.dataset.itemid;shoppingcart.querySelector('[id^="item-'+component+"-"+itemid+'"]')?addtocartbutton.classList.add("disabled"):addtocartbutton.classList.remove("disabled")}))}_exports.updateTotalPrice=updateTotalPrice}));

//# sourceMappingURL=cart.min.js.map