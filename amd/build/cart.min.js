define("local_shopping_cart/cart",["exports","core/ajax","core/templates","core/notification","core/modal_factory","core/modal_events","local_shopping_cart/cashier","core/str"],(function(_exports,_ajax,_templates,_notification,_modal_factory,_modal_events,_cashier,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * @package    local_shopping_cart
   * @copyright  Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.visbilityevent=_exports.updateTotalPrice=_exports.reloadAllButtons=_exports.reinit=_exports.interval=_exports.init=_exports.deleteItem=_exports.deleteAllItems=_exports.countdownelement=_exports.buttoninit=_exports.addItem=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events);var countdownelement=null;_exports.countdownelement=countdownelement;var interval=null;_exports.interval=interval;var visbilityevent=!1;_exports.visbilityevent=visbilityevent;const reloadAllButtons=()=>{document.querySelectorAll("[id^=btn-]").forEach((button=>{button.classList.remove("disabled")}))};_exports.reloadAllButtons=reloadAllButtons;const buttoninit=(id,component)=>{if(!id){return void document.querySelectorAll("[id^='btn-"+component+"']").forEach((button=>{const number=button.id.split(/[\s-]+/).pop();buttoninit(number,component)}))}const addtocartbutton=document.querySelector("#btn-"+component+"-"+id);if(!addtocartbutton||addtocartbutton.dataset.initialized)return;let shoppingcart=document.querySelector("#shopping_cart-cashiers-cart");if(shoppingcart||(shoppingcart=document.querySelector("#nav-shopping_cart-popover-container")),shoppingcart){shoppingcart.querySelector("[id^=item-"+component+"-"+id+"]")&&addtocartbutton.classList.add("disabled")}addtocartbutton.addEventListener("click",(event=>{console.log("button clicked",id),addtocartbutton.classList.contains("disabled")||(event.preventDefault(),event.stopPropagation(),addItem(id,component))})),addtocartbutton.dataset.initialized=!0};_exports.buttoninit=buttoninit;_exports.init=expirationdate=>{if(_exports.countdownelement=countdownelement=document.querySelector(".expirationdate"),initTimer(expirationdate),0==visbilityevent){let items=document.querySelectorAll("[id^=item-] .fa-trash-o");items.forEach((item=>{addDeleteevent(item)})),items=document.querySelectorAll("[id^=item-] .fa-eur"),items.forEach((item=>{(0,_cashier.addDiscountEvent)(item)})),document.addEventListener("visibilitychange",(function(){_exports.visbilityevent=visbilityevent=!0,"visible"===document.visibilityState&&reinit()}))}updateTotalPrice()};const reinit=()=>{reloadAllButtons(),_ajax.default.call([{methodname:"local_shopping_cart_get_shopping_cart_items",args:{},done:function(data){_templates.default.renderForPromise("local_shopping_cart/shopping_cart_items",data).then((_ref=>{let{html:html}=_ref;document.querySelector(".shopping-cart-items").remove(),document.querySelector("#nav-shopping_cart-popover-container .shopping-cart-items-container").insertAdjacentHTML("afterbegin",html),data.items.forEach((item=>{buttoninit(item.itemid,item.itemcomponent)})),document.querySelectorAll(".fa-trash-o").forEach((item=>{addDeleteevent(item)}));let itemcount=document.getElementById("itemcount");return itemcount.innerHTML=data.count,document.getElementById("countbadge").innerHTML=data.count,data.count>0?itemcount.classList.remove("hidden"):itemcount.classList.add("hidden"),initTimer(data.expirationdate),!0})).catch((e=>{console.log(e)}))},fail:function(ex){console.log("ex:"+ex)}}])};_exports.reinit=reinit;const deleteAllItems=()=>{_ajax.default.call([{methodname:"local_shopping_cart_delete_all_items_from_cart",args:{},done:function(){document.querySelectorAll("[id^=item-]").forEach((item=>{item&&item.remove()})),updateTotalPrice();let itemcount1=document.getElementById("countbadge"),itemcount2=document.getElementById("itemcount");itemcount1.innerHTML=0,itemcount2.innerHTML=0,itemcount2.classList.add("hidden");document.querySelectorAll("[id^=btn-].disabled").forEach((btn=>{btn&&btn.classList.remove("disabled")})),console.log("All items have been removed from cart.")},fail:function(ex){console.log(ex)}}])};_exports.deleteAllItems=deleteAllItems;const deleteItem=(id,component,userid)=>{_ajax.default.call([{methodname:"local_shopping_cart_delete_item",args:{itemid:id,component:component,userid:userid},done:function(){document.querySelectorAll("[id^=item-"+component+"-"+id+"]").forEach((item=>{item&&item.remove()})),updateTotalPrice(userid);let itemcount1=document.getElementById("countbadge"),itemcount2=document.getElementById("itemcount");itemcount1.innerHTM=itemcount1.innerHTML>0?itemcount1.innerHTML-=1:itemcount1.innerHTML,itemcount2.innerHTML=itemcount2.innerHTML>0?itemcount2.innerHTML-=1:itemcount1.innerHTML,0==itemcount2.innerHTML&&(itemcount2.classList.add("hidden"),clearInterval(interval),initTimer());const addtocartbutton=document.querySelector("#btn-"+component+"-"+id);addtocartbutton&&(addtocartbutton.classList.remove("disabled"),buttoninit(id,component))},fail:function(ex){console.log(id,ex);let item=document.querySelector("[id^=item-"+component+"-"+id+"]");if(item){item.remove();let itemcount1=document.getElementById("countbadge"),itemcount2=document.getElementById("itemcount");itemcount1.innerHTML=itemcount1.innerHTML>0?itemcount1.innerHTML-=1:itemcount1.innerHTML,itemcount2.innerHTML=itemcount2.innerHTML>0?itemcount2.innerHTML-=1:itemcount1.innerHTML,itemcount2.innerHTML=0==itemcount2.innerHTML?itemcount2.classList.add("hidden"):itemcount2.innerHTML;let itemprice=item.dataset.price;console.log("itemprice",itemprice),updateTotalPrice(userid)}}}])};_exports.deleteItem=deleteItem;const addItem=(id,component)=>{let userid=0;window.location.href.indexOf("cashier.php")>0&&(userid=-1),_ajax.default.call([{methodname:"local_shopping_cart_add_item",args:{component:component,itemid:id,userid:userid},done:function(data){if(data.component=component,data.id=id,data.userid=data.buyforuser,1!=data.success)return _notification.default.addNotification({message:"Cart is full",type:"danger"}),void setTimeout((()=>{let notificationslist=document.querySelectorAll("#user-notifications div.alert.alert-danger");notificationslist[notificationslist.length-1].remove()}),5e3);if(1==data.success){_notification.default.addNotification({message:data.itemname+" added to cart",type:"success"}),setTimeout((()=>{let notificationslist=document.querySelectorAll("#user-notifications div.alert.alert-success");notificationslist[notificationslist.length-1].remove()}),5e3);window.location.href.indexOf("cashier.php")&&(data.iscashier=!0),_templates.default.renderForPromise("local_shopping_cart/shopping_cart_item",data).then((_ref2=>{let{html:html}=_ref2;document.querySelectorAll("[id^='liinitialtotal']").forEach((lastElem=>{console.log("found li",lastElem),0!=data.buyforuser&&"liinitialtotal_cashier"!==lastElem.id||lastElem.insertAdjacentHTML("beforeBegin",html)}));const addtocartbutton=document.querySelector("#btn-"+component+"-"+data.itemid);addtocartbutton&&(addtocartbutton.classList.add("disabled"),addtocartbutton.removeEventListener("click",deleteEvent));let items=document.querySelectorAll("[id^=item-"+component+"-"+data.itemid+"] .fa-trash-o");if(items.forEach((item=>{addDeleteevent(item,data.userid)})),items=document.querySelectorAll("[id^=item-"+component+"-"+data.itemid+"] .fa-eur"),items.forEach((item=>{(0,_cashier.addDiscountEvent)(item,data.userid)})),updateTotalPrice(data.userid),0!=data.buyforuser)return;document.getElementById("countbadge").innerHTML++;const badge=document.getElementById("itemcount");badge.innerHTML=(parseInt(badge.innerHTML)||0)+1,badge.classList.remove("hidden"),updateTotalPrice(data.userid),clearInterval(interval),initTimer(data.expirationdate)})).catch((e=>{console.log(e)}))}},fail:function(ex){console.log("error",ex)}}],!0)};_exports.addItem=addItem;const updateTotalPrice=function(){let userid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,usecredit=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];console.log("updatetotalprice");const oncashier=window.location.href.indexOf("cashier.php");let labelareas=null;labelareas=oncashier>0?document.querySelectorAll("div.sc_price_label"):document.querySelectorAll("li.sc_price_label"),labelareas.forEach((element=>{console.log(element),userid=element.dataset.userid?element.dataset.userid:userid;const checkbox=element.querySelector("input.usecredit-checkbox");checkbox&&(checkbox.checked?(console.log("checked",checkbox.checked),usecredit=checkbox.checked):usecredit=0)})),usecredit=usecredit?1:0,console.log("usecredit before ajax",usecredit),_ajax.default.call([{methodname:"local_shopping_cart_get_price",args:{userid:userid,usecredit:usecredit},done:function(data){console.log(data),1==data.usecredit?data.usecreditclass="checked":data.usecreditclass="";const initialtotal=data.initialtotal;let shoppingcart=document.querySelector("#shopping_cart-cashiers-cart"),cashierssection=null,checkoutcart=null,checkouttotals=null;shoppingcart?cashierssection=document.querySelector("#shopping_cart-cashiers-section"):(shoppingcart=document.querySelector("#nav-shopping_cart-popover-container"),checkoutcart=document.querySelector("div.checkoutgrid.checkout"),console.log("1",checkoutcart));let totals=[];cashierssection?totals=cashierssection.querySelectorAll(".initialtotal"):(totals=shoppingcart.querySelectorAll(".initialtotal"),checkoutcart&&(checkouttotals=checkoutcart.querySelectorAll(".initialtotal"),checkouttotals&&checkouttotals.forEach((total=>{total.innerHTML=initialtotal}))));let paymentbutton=document.querySelector(".shopping_cart_payment_region button");if(paymentbutton){const price=data.price,currency=data.currency;console.log("paymentbutton",price,currency),paymentbutton.dataset.cost=price+" "+currency,0==price?(console.log("price is 0"),paymentbutton.addEventListener("click",dealWithZeroPrice)):(console.log("price is not 0"),paymentbutton.removeEventListener("click",dealWithZeroPrice))}totals.forEach((total=>{total.innerHTML=initialtotal})),data.checkboxid=Math.random().toString(36).slice(2,5),_templates.default.renderForPromise("local_shopping_cart/price_label",data).then((_ref3=>{let{html:html}=_ref3;return labelareas.forEach((element=>{let child=element.lastElementChild;for(;child;)element.removeChild(child),child=element.lastElementChild;element.insertAdjacentHTML("afterbegin",html);const checkbox=element.querySelector("input.usecredit-checkbox");checkbox&&checkbox.addEventListener("change",(event=>{console.log(event),updateTotalPrice(userid)}))})),!0})).catch((e=>{console.log(e)}))},fail:function(ex){console.log("error",ex)}}],!0)};function dealWithZeroPrice(event){var element;console.log("onlymyclickcounts"),event.stopPropagation(),event.preventDefault(),console.log("onlymyclickcounts",event.target),element=event.target,(0,_str.get_strings)([{key:"confirmzeropricecheckouttitle",component:"local_shopping_cart"},{key:"confirmzeropricecheckoutbody",component:"local_shopping_cart"},{key:"confirmzeropricecheckout",component:"local_shopping_cart"}]).then((strings=>(_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL}).then((modal=>(modal.setTitle(strings[0]),modal.setBody(strings[1]),modal.setSaveButtonText(strings[2]),modal.getRoot().on(_modal_events.default.save,(function(){const userid=element.dataset.userid;console.log(userid),userid&&(0,_cashier.confirmPayment)(userid)})),modal.show(),modal))).catch((e=>{console.log(e)})),!0))).catch((e=>{console.log(e)}))}function addDeleteevent(item){let userid=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;0!=userid&&(item.dataset.userid=userid),item.addEventListener("click",deleteEvent)}function deleteEvent(){console.log("item",this);const idarray=this.dataset.id.split("-");idarray.length>3&&idarray.pop(),console.log("idarray",idarray);const id=idarray.pop(),component=idarray.pop();let userid=parseInt(this.dataset.userid);userid||(userid=0),deleteItem(id,component,userid)}function startTimer(duration,display){var minutes,seconds,timer=duration;_exports.interval=interval=setInterval((function(){minutes=parseInt(timer/60,10),seconds=parseInt(timer%60,10),minutes=minutes<10?"0"+minutes:minutes,seconds=seconds<10?"0"+seconds:seconds,display.textContent=minutes+":"+seconds,--timer<0&&(deleteAllItems(),clearInterval(interval))}),1e3)}function initTimer(){let expirationdate=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;interval&&clearInterval(interval);let delta=0,now=Date.now("UTC");now=(new Date).getTime()/1e3,expirationdate&&(delta=expirationdate-now),delta<=0?(delta=0,countdownelement.classList.add("hidden")):delta>0&&(countdownelement.classList.remove("hidden"),startTimer(delta,countdownelement))}_exports.updateTotalPrice=updateTotalPrice}));

//# sourceMappingURL=cart.min.js.map