define("local_shopping_cart/cart",["exports","core/ajax","core/templates","core/modal_factory","core/modal_events","local_shopping_cart/cashier","local_shopping_cart/notifications","core/str"],(function(_exports,_ajax,_templates,_modal_factory,_modal_events,_cashier,_notifications,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * @package    local_shopping_cart
   * @copyright  Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=_exports.deleteItem=_exports.deleteAllItems=_exports.buttoninit=_exports.addItem=void 0,_exports.initPriceLabel=function(userid){userid<1&&(userid=0);var checkbox=document.querySelector(SELECTORS_PRICELABELCHECKBOX);checkbox&&checkbox.addEventListener("change",(function(event){event.currentTarget.checked?updateTotalPrice(userid,!0):updateTotalPrice(userid,!1)}))},_exports.visbilityevent=_exports.updateTotalPrice=_exports.reinit=_exports.interval=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events);var interval=null;_exports.interval=interval;var visbilityevent=!1;_exports.visbilityevent=visbilityevent;var SELECTORS_NAVBARCONTAINER="#nav-shopping_cart-popover-container .shopping-cart-items-container",SELECTORS_TRASHCLASS="fa-trash-o",SELECTORS_DISCOUNTCLASS="fa-eur",SELECTORS_BADGECOUNT="#nav-shopping_cart-popover-container div.count-container",SELECTORS_COUNTDOWN="#nav-shopping_cart-popover-container span.expirationdate",SELECTORS_CASHIERSCART="div.shopping-cart-cashier-items-container",SELECTORS_CHECKOUTCART="div.shopping-cart-checkout-items-container",SELECTORS_PRICELABELCHECKBOX=".sc_price_label input.usecredit-checkbox",SELECTORS_PRICELABELAREA=".sc_price_label",SELECTORS_CHECKOUTBUTTON="#nav-shopping_cart-popover-container #shopping-cart-checkout-button",SELECTORS_PAYMENTREGIONBUTTON="div.shopping_cart_payment_region button";_exports.init=function(expirationdate){initTimer(expirationdate);document.querySelectorAll(SELECTORS_NAVBARCONTAINER+","+SELECTORS_CASHIERSCART+","+SELECTORS_CHECKOUTCART).forEach((function(container){container.addEventListener("click",(function(event){var element=event.target;if(element.classList.contains(SELECTORS_TRASHCLASS)){var userid=element.dataset.userid?element.dataset.userid:0,component=element.dataset.component,area=element.dataset.area,itemid=element.dataset.itemid;deleteItem(itemid,component,area,userid)}else element.classList.contains(SELECTORS_DISCOUNTCLASS)&&(0,_cashier.discountModal)(event)}))})),0==visbilityevent&&document.addEventListener("visibilitychange",(function(){_exports.visbilityevent=visbilityevent=!0,"visible"===document.visibilityState&&reinit()}));var paymentbutton=document.querySelector(SELECTORS_PAYMENTREGIONBUTTON);paymentbutton&&addZeroPriceListener({price:paymentbutton.dataset.price,currency:paymentbutton.dataset.currency})};_exports.buttoninit=function buttoninit(itemid,component,area){if(itemid&&component&&area){document.querySelectorAll('button[data-itemid="'+itemid+'"][data-component="'+component+'"][data-area="'+area+'"][data-objecttable="local_shopping_cart"').forEach((function(addtocartbutton){toggleActiveButtonState(addtocartbutton),addtocartbutton&&"true"!==addtocartbutton.dataset.initialized&&(addtocartbutton.dataset.initialized="true",addtocartbutton.addEventListener("click",(function(event){addtocartbutton.classList.contains("disabled")||(event.preventDefault(),event.stopPropagation(),addItem(itemid,component,area))})))}))}else{document.querySelectorAll('[data-objecttable="local_shopping_cart"').forEach((function(button){var itemid=button.dataset.itemid,area=button.dataset.area,component=button.dataset.component;buttoninit(itemid,component,area)}))}};var reinit=function(){var userid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;userid=transformUserIdForCashier(userid),_ajax.default.call([{methodname:"local_shopping_cart_get_shopping_cart_items",args:{userid:userid},done:function(data){var oncashier=window.location.href.indexOf("cashier.php");data.iscashier=oncashier>0;var containers=[];containers=0!=userid&&data.iscashier?document.querySelectorAll(SELECTORS_CASHIERSCART):document.querySelectorAll(SELECTORS_NAVBARCONTAINER+","+SELECTORS_CHECKOUTCART);var promises=[];promises.push(_templates.default.renderForPromise("local_shopping_cart/shopping_cart_items",data).then((function(_ref){var html=_ref.html,js=_ref.js;return containers.forEach((function(container){_templates.default.replaceNodeContents(container,html,js)})),!0})).catch((function(e){console.log(e)}))),Promise.all(promises).then((function(){0!=userid&&data.iscashier||(clearInterval(interval),initTimer(data.expirationdate),updateBadge(data.count)),toggleActiveButtonState(),updateTotalPrice(userid)})).catch((function(e){console.log(e)}))},fail:function(ex){console.log("ex:"+ex)}}])};_exports.reinit=reinit;var deleteAllItems=function(){_ajax.default.call([{methodname:"local_shopping_cart_delete_all_items_from_cart",args:{},done:function(){reinit(0)},fail:function(ex){console.log(ex)}}])};_exports.deleteAllItems=deleteAllItems;var deleteItem=function(itemid,component,area,userid){userid=transformUserIdForCashier(userid),_ajax.default.call([{methodname:"local_shopping_cart_delete_item",args:{itemid:itemid,component:component,area:area,userid:userid},done:function(){reinit(userid)},fail:function(){reinit(userid)}}])};_exports.deleteItem=deleteItem;var addItem=function(itemid,component,area){var userid=transformUserIdForCashier();Number.isInteger(userid)||(userid=parseInt(userid)),_ajax.default.call([{methodname:"local_shopping_cart_add_item",args:{area:area,component:component,itemid:itemid,userid:userid},done:function(data){data.component=component,data.area=area,data.itemid=itemid,data.userid=userid,1==data.success?1==data.success&&((0,_str.get_string)("addedtocart","local_shopping_cart",data.itemname).then((function(message){(0,_notifications.showNotification)(message,"success")})).catch((function(e){console.log(e)})),reinit(userid)):(0,_str.get_string)("cartisfull","local_shopping_cart").then((function(message){(0,_notifications.showNotification)(message,"danger")})).catch((function(e){console.log(e)}))},fail:function(ex){console.log("error",ex)}}],!0)};_exports.addItem=addItem;var updateTotalPrice=function(){var userid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,usecredit=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],oncashier=window.location.href.indexOf("cashier.php");oncashier>0&&(userid=-1),Number.isInteger(userid)||(userid=parseInt(userid)),usecredit=usecredit?1:0,_ajax.default.call([{methodname:"local_shopping_cart_get_price",args:{userid:userid,usecredit:usecredit},done:function(data){1==data.usecredit?data.usecreditvalue="checked":data.usecreditvalue="",data.checkboxid=Math.random().toString(36).slice(2,5),data.userid=userid;var labelareas=document.querySelectorAll(SELECTORS_PRICELABELAREA);_templates.default.renderForPromise("local_shopping_cart/price_label",data).then((function(_ref2){var html=_ref2.html,js=_ref2.js;return labelareas.forEach((function(labelarea){_templates.default.replaceNodeContents(labelarea,html,js),addZeroPriceListener(data)})),!0})).catch((function(e){console.log(e)}));var checkoutButton=document.querySelector(SELECTORS_CHECKOUTBUTTON);0==data.count?checkoutButton.classList.add("disabled"):checkoutButton.classList.remove("disabled")},fail:function(ex){console.log("error",ex)}}],!0)};function addZeroPriceListener(data){var paymentbutton=document.querySelector(".shopping_cart_payment_region button");if(paymentbutton){var price=data.price,currency=data.currency;paymentbutton.dataset.cost=price+" "+currency,0==price?paymentbutton.addEventListener("click",dealWithZeroPrice):paymentbutton.removeEventListener("click",dealWithZeroPrice)}}function dealWithZeroPrice(event){var element;event.stopPropagation(),event.preventDefault(),element=event.target,(0,_str.get_strings)([{key:"confirmzeropricecheckouttitle",component:"local_shopping_cart"},{key:"confirmzeropricecheckoutbody",component:"local_shopping_cart"},{key:"confirmzeropricecheckout",component:"local_shopping_cart"}]).then((function(strings){return _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL}).then((function(modal){return modal.setTitle(strings[0]),modal.setBody(strings[1]),modal.setSaveButtonText(strings[2]),modal.getRoot().on(_modal_events.default.save,(function(){var userid=element.dataset.userid;userid&&(0,_cashier.confirmPayment)(userid,2)})),modal.show(),modal})).catch((function(e){console.log(e)})),!0})).catch((function(e){console.log(e)}))}function startTimer(duration,display){var minutes,seconds,timer=duration;_exports.interval=interval=setInterval((function(){minutes=parseInt(timer/60,10),seconds=parseInt(timer%60,10),minutes=minutes<10?"0"+minutes:minutes,seconds=seconds<10?"0"+seconds:seconds,display.textContent=minutes+":"+seconds,--timer<0&&(deleteAllItems(),clearInterval(interval))}),1e3)}function initTimer(){var expirationdate=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,countdownelement=document.querySelector(SELECTORS_COUNTDOWN);if(countdownelement){interval&&clearInterval(interval);var delta=0,now=Date.now("UTC");now=(new Date).getTime()/1e3,expirationdate&&(delta=expirationdate-now),delta<=0?(delta=0,countdownelement.classList.add("hidden")):delta>0&&(countdownelement.classList.remove("hidden"),startTimer(delta,countdownelement))}}function updateBadge(count){var badge=document.querySelector(SELECTORS_BADGECOUNT);count>0?(badge.innerHTML=count,badge.classList.remove("hidden")):(badge.innerHTML=count,badge.classList.add("hidden"))}function toggleActiveButtonState(){var button=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,selector="",component=null,area=null,itemid=null;button?(itemid=button.dataset.itemid,component=button.dataset.component,area=button.dataset.area,selector='button[data-itemid="'+itemid+'"][data-component="'+component+'"][data-area="'+area+'"][data-objecttable="local_shopping_cart"'):selector='button[data-objecttable="local_shopping_cart"';var buttons=document.querySelectorAll(selector),shoppingcart=document.querySelector(SELECTORS_CASHIERSCART);shoppingcart||(shoppingcart=document.querySelector(SELECTORS_NAVBARCONTAINER)),buttons.forEach((function(addtocartbutton){component=addtocartbutton.dataset.component,area=addtocartbutton.dataset.area,itemid=addtocartbutton.dataset.itemid,shoppingcart.querySelector('[id^="item-'+component+"-"+area+"-"+itemid+'"]')?addtocartbutton.classList.add("disabled"):addtocartbutton.classList.remove("disabled")}))}function transformUserIdForCashier(){var userid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,oncashier=window.location.href.indexOf("cashier.php");return(-1==userid||0!==userid&&"0"!==userid)&&oncashier>0?userid=-1:null===userid&&(userid=0),Number.isInteger(userid)||(userid=parseInt(userid)),userid}_exports.updateTotalPrice=updateTotalPrice}));

//# sourceMappingURL=cart.min.js.map