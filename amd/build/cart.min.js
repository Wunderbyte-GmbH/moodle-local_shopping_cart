define ("local_shopping_cart/cart",["exports","core/ajax","core/templates","core/notification","core/modal_factory","core/modal_events","local_shopping_cart/cachier","core/str"],function(a,b,c,d,e,f,g,h){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.updateTotalPrice=a.addItem=a.deleteItem=a.deleteAllItems=a.reinit=a.init=a.buttoninit=a.reloadAllButtons=a.visbilityevent=a.interval=a.countdownelement=void 0;b=i(b);c=i(c);d=i(d);e=i(e);f=i(f);function i(a){return a&&a.__esModule?a:{default:a}}var p=null;a.countdownelement=p;var q=null;a.interval=q;var r=!1;a.visbilityevent=r;var s=function(){var a=document.querySelectorAll("[id^=btn-]");a.forEach(function(a){a.classList.remove("disabled")})};a.reloadAllButtons=s;var t=function(a,b){if(!a){var e=document.querySelectorAll("[id^='btn-"+b+"']");e.forEach(function(a){var c=a.id.split(/[\s-]+/).pop();t(c,b)});return}var c=document.querySelector("#btn-"+b+"-"+a);if(!c||c.dataset.initialized){return}var d=document.querySelector("#shopping_cart-cashiers-cart");if(!d){d=document.querySelector("#nav-shopping_cart-popover-container")}if(d){var f=d.querySelector("#item-"+b+"-"+a);if(f){c.classList.add("disabled")}}c.addEventListener("click",function(d){console.log("button clicked",a);if(c.classList.contains("disabled")){return}d.preventDefault();d.stopPropagation();y(a,b)});c.dataset.initialized=!0};a.buttoninit=t;var u=function(b){a.countdownelement=p=document.querySelector(".expirationdate");n(b);if(!1==r){var c=document.querySelectorAll("[id^=item-] .fa-trash-o");c.forEach(function(a){k(a)});document.addEventListener("visibilitychange",function(){a.visbilityevent=r=!0;if("visible"===document.visibilityState){v()}})}z()};a.init=u;var v=function(){s();b.default.call([{methodname:"local_shopping_cart_get_shopping_cart_items",args:{},done:function done(a){c.default.renderForPromise("local_shopping_cart/shopping_cart_items",a).then(function(b){var c=b.html;document.querySelector(".shopping-cart-items").remove();var d=document.querySelector("#nav-shopping_cart-popover-container .shopping-cart-items-container");d.insertAdjacentHTML("afterbegin",c);a.items.forEach(function(a){t(a.itemid,a.itemcomponent)});var e=document.querySelectorAll(".fa-trash-o");e.forEach(function(a){k(a)});var f=document.getElementById("itemcount");f.innerHTML=a.count;document.getElementById("countbadge").innerHTML=a.count;if(0<a.count){f.classList.remove("hidden")}else{f.classList.add("hidden")}n(a.expirationdate);return!0}).catch(function(a){console.log(a)})},fail:function fail(a){console.log("ex:"+a)}}])};a.reinit=v;var w=function(){b.default.call([{methodname:"local_shopping_cart_delete_all_items_from_cart",args:{},done:function done(){var a=document.querySelectorAll("[id^=item-]");a.forEach(function(a){if(a){a.remove()}});z();var b=document.getElementById("countbadge"),c=document.getElementById("itemcount");b.innerHTML=0;c.innerHTML=0;c.classList.add("hidden");var d=document.querySelectorAll("[id^=btn-].disabled");d.forEach(function(a){if(a){a.classList.remove("disabled")}})},fail:function fail(a){console.log(a)}}])};a.deleteAllItems=w;var x=function(a,c,d){b.default.call([{methodname:"local_shopping_cart_delete_item",args:{itemid:a,component:c,userid:d},done:function done(){var b=document.querySelectorAll("#item-"+c+"-"+a);b.forEach(function(a){if(a){a.remove()}});z(d);var e=document.getElementById("countbadge"),f=document.getElementById("itemcount");e.innerHTM=0<e.innerHTML?e.innerHTML-=1:e.innerHTML;f.innerHTML=0<f.innerHTML?f.innerHTML-=1:e.innerHTML;if(0==f.innerHTML){f.classList.add("hidden");clearInterval(q);n()}var g=document.querySelector("#btn-"+c+"-"+a);if(g){g.classList.remove("disabled");t(a,c)}},fail:function fail(b){console.log(a,b);var e=document.querySelector("#item-"+c+"-"+a);if(e){e.remove();var f=document.getElementById("countbadge"),g=document.getElementById("itemcount");f.innerHTML=0<f.innerHTML?f.innerHTML-=1:f.innerHTML;g.innerHTML=0<g.innerHTML?g.innerHTML-=1:f.innerHTML;g.innerHTML=0==g.innerHTML?g.classList.add("hidden"):g.innerHTML;var h=e.dataset.price;console.log("itemprice",h);z(d)}}}])};a.deleteItem=x;var y=function(a,e){var f=window.location.href.indexOf("cashier.php"),g=0;if(0<f){g=-1}b.default.call([{methodname:"local_shopping_cart_add_item",args:{component:e,itemid:a,userid:g},done:function done(b){b.component=e;b.id=a;b.userid=b.buyforuser;if(1!=b.success){d.default.addNotification({message:"Cart is full",type:"danger"});setTimeout(function(){var a=document.querySelectorAll("#user-notifications div.alert.alert-danger"),b=a[a.length-1];b.remove()},5e3)}else if(1==b.success){d.default.addNotification({message:b.itemname+" added to cart",type:"success"});setTimeout(function(){var a=document.querySelectorAll("#user-notifications div.alert.alert-success"),b=a[a.length-1];b.remove()},5e3);c.default.renderForPromise("local_shopping_cart/shopping_cart_item",b).then(function(a){var c=a.html,d=document.querySelectorAll("[id^='liinitialtotal']");d.forEach(function(a){console.log("found li",a);if(0==b.buyforuser||"liinitialtotal_cashier"===a.id){a.insertAdjacentHTML("beforeBegin",c)}});var f=document.querySelector("#btn-"+e+"-"+b.itemid);if(f){f.classList.add("disabled");f.removeEventListener("click",l)}var g=document.querySelectorAll("#item-"+e+"-"+b.itemid+" .fa-trash-o");g.forEach(function(a){k(a,b.userid)});z(b.userid);if(0!=b.buyforuser){return}document.getElementById("countbadge").innerHTML++;var h=document.getElementById("itemcount");h.innerHTML=(parseInt(h.innerHTML)||0)+1;h.classList.remove("hidden");z(b.userid);clearInterval(q);n(b.expirationdate)}).catch(function(a){console.log(a)})}},fail:function fail(a){console.log("error",a)}}],!0)};a.addItem=y;var z=function(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:0,d=1<arguments.length&&arguments[1]!==void 0?arguments[1]:!0;console.log("updatetotalprice");var e=window.location.href.indexOf("cashier.php"),f=null;if(0<e){f=document.querySelectorAll("div.sc_price_label")}else{f=document.querySelectorAll("li.sc_price_label")}f.forEach(function(b){console.log(b);a=b.dataset.userid?b.dataset.userid:a;var c=b.querySelector("input.usecredit-checkbox");if(c){if(c.checked){console.log("checked",c.checked);d=c.checked}else{d=0}}});d=d?1:0;console.log("usecredit before ajax",d);b.default.call([{methodname:"local_shopping_cart_get_price",args:{userid:a,usecredit:d},done:function done(b){console.log(b);if(1==b.usecredit){b.usecreditclass="checked"}else{b.usecreditclass=""}var d=b.initialtotal,e=document.querySelector("#shopping_cart-cashiers-cart"),g=null,h=null,i=null;if(!e){e=document.querySelector("#nav-shopping_cart-popover-container");h=document.querySelector("div.checkoutgrid.checkout");console.log("1",h)}else{g=document.querySelector("#shopping_cart-cashiers-section")}var k=[];if(g){k=g.querySelectorAll(".initialtotal")}else{k=e.querySelectorAll(".initialtotal");if(h){i=h.querySelectorAll(".initialtotal");if(i){i.forEach(function(a){a.innerHTML=d})}}}var l=document.querySelector(".shopping_cart_payment_region button");if(l){var m=b.price,n=b.currency;console.log("paymentbutton",m,n);l.dataset.cost=m+" "+n;if(0==m){console.log("price is 0");l.addEventListener("click",j)}else{console.log("price is not 0");l.removeEventListener("click",j)}}k.forEach(function(a){a.innerHTML=d});b.checkboxid=Math.random().toString(36).slice(2,5);c.default.renderForPromise("local_shopping_cart/price_label",b).then(function(b){var c=b.html;f.forEach(function(b){var d=b.lastElementChild;while(d){b.removeChild(d);d=b.lastElementChild}b.insertAdjacentHTML("afterbegin",c);var e=b.querySelector("input.usecredit-checkbox");if(e){e.addEventListener("change",function(b){console.log(b);z(a)})}});return!0}).catch(function(a){console.log(a)})},fail:function fail(a){console.log("error",a)}}],!0)};a.updateTotalPrice=z;function j(a){console.log("onlymyclickcounts");a.stopPropagation();a.preventDefault();console.log("onlymyclickcounts",a.target);o(a.target)}function k(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0;if(0!=b){a.dataset.userid=b}a.addEventListener("click",l)}function l(){var a=this;console.log("item",a);var b=a.dataset.id.split("-");console.log("idarray",b);var c=b.pop(),d=b.pop(),e=parseInt(a.dataset.userid);if(!e){e=0}x(c,d,e)}function m(b,c){var d=b,e,f;a.interval=q=setInterval(function(){e=parseInt(d/60,10);f=parseInt(d%60,10);e=10>e?"0"+e:e;f=10>f?"0"+f:f;c.textContent=e+":"+f;if(0>--d){w();clearInterval(q)}},1e3)}function n(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null;if(q){clearInterval(q)}var b=0,c=Date.now("UTC");c=new Date().getTime()/1e3;if(a){b=a-c}if(0>=b){b=0;p.classList.add("hidden")}else if(0<b){p.classList.remove("hidden");m(b,p)}}function o(a){(0,h.get_strings)([{key:"confirmzeropricecheckouttitle",component:"local_shopping_cart"},{key:"confirmzeropricecheckoutbody",component:"local_shopping_cart"},{key:"confirmzeropricecheckout",component:"local_shopping_cart"}]).then(function(b){e.default.create({type:e.default.types.SAVE_CANCEL}).then(function(c){c.setTitle(b[0]);c.setBody(b[1]);c.setSaveButtonText(b[2]);c.getRoot().on(f.default.save,function(){var b=a.dataset.userid;console.log(b);if(b){(0,g.confirmPayment)(b)}});c.show();return c}).catch(function(a){console.log(a)});return!0}).catch(function(a){console.log(a)})}});
//# sourceMappingURL=cart.min.js.map
