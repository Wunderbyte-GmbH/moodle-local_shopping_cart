{"version":3,"file":"checkout_manager.min.js","sources":["../src/checkout_manager.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @package    local_shopping_cart\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport ModalFactory from 'core/modal_factory';\nimport {get_string as getString} from 'core/str';\n\nimport {reinit} from 'local_shopping_cart/cart';\n\nconst SELECTORS = {\n    CHECKOUTMANAGERFORMID: '#shopping-cart-checkout-manager-form',\n    CHECKOUTMANAGERFORMTEMPLATE: 'local_shopping_cart/checkout_manager_form',\n    CHECKOUTMANAGERBUTTONSTEMPLATE: 'local_shopping_cart/checkout_manager_form_buttons',\n    CHECKOUTMANAGERBUTTONSID: 'shopping-cart-checkout-manager-buttons',\n    CHECKOUTMANAGERPROGRESSBARTEMPLATE: 'local_shopping_cart/checkout_manager_form_progress_bar',\n    CHECKOUTMANAGERPROGRESSBARID: 'shopping-cart-checkout-manager-status-bar',\n    BUTTONS: '.shopping-cart-checkout-manager-buttons button',\n    PROGRESSBUTTONS: '.shopping-cart-checkout-manager-status-bar button',\n    CHECKBOXITEMBODY: '#shopping-cart-checkout-manager-form-body',\n    NEWADDRESSBUTTON: '.shopping-cart-new-address',\n    FEEDBACKMESSAGE: '.shopping-cart-checkout-manager-alert-container',\n    PAYMENTREGIONBUTTON: 'div.shopping_cart_payment_region button'\n};\n\nconst WEBSERVICE = {\n    CHECKOUTPROCESS: 'local_shopping_cart_control_checkout_process',\n};\n\nconst EVENTSLISTENING = {\n    ADDRESSREDRAWN: 'local_shopping_cart/addressesRedrawn',\n};\n\nconst IDS = {\n    VATNUMBER: 'shopping-cart-checkout-manager-vat-number',\n    VERIFYVAT: 'shopping-cart-checkout-manager-verify-vat',\n    COUNTRYSELECT: 'shopping-cart-checkout-manager-country-select',\n};\n\n/**\n * Initializes the checkout manager functionality.\n */\nfunction init() {\n    const formBody = document.querySelector(SELECTORS.CHECKBOXITEMBODY);\n    initListeners(formBody);\n    document.addEventListener(EVENTSLISTENING.ADDRESSREDRAWN, getNewAddress);\n}\n\n/**\n * Initializes the checkout manager functionality.\n * @param {HTMLElement} formBody - The name of the web service.\n */\nfunction initListeners(formBody) {\n    initControlListener();\n    if (formBody != undefined) {\n        initChangeListener();\n        initVatNumberVerifyListener(formBody);\n    }\n\n}\n\n/**\n * Initializes the change listener for the form body.\n */\nfunction getNewAddress() {\n    const formBody = document.querySelector(SELECTORS.CHECKBOXITEMBODY);\n    const currentstep = getDatasetValue(formBody, 'currentstep');\n    if (currentstep !== null) {\n        triggerButtonControlWebService(WEBSERVICE.CHECKOUTPROCESS, {\n            action: '',\n            currentstep: currentstep,\n        });\n    }\n}\n\n/**\n * Initializes the change listener for the form body.\n */\nfunction initVatNumberVerifyListener() {\n    const vatNumber = document.getElementById(IDS.VERIFYVAT);\n    if (vatNumber) {\n        vatNumber.addEventListener('click', vatNumberVerifyCallback);\n    }\n}\n\n/**\n * Initializes the change listener for the form body.\n */\nfunction vatNumberVerifyCallback() {\n    const formBody = document.querySelector(SELECTORS.CHECKBOXITEMBODY);\n    const countryCode = document.getElementById(IDS.COUNTRYSELECT)?.value;\n    const vatNumber = document.getElementById(IDS.VATNUMBER)?.value;\n\n    if (!countryCode || !vatNumber) {\n        ModalFactory.create({type: ModalFactory.types.CANCEL}).then(modal => {\n            modal.setTitle(getString('errorinvalidvatdatatitle', 'local_shopping_cart'));\n            modal.setBody(getString('errorinvalidvatdatadescription', 'local_shopping_cart'));\n            modal.show();\n            return modal;\n        }).catch(e => {\n            // eslint-disable-next-line no-console\n            console.log(e);\n        });\n        return;\n    }\n    triggerButtonControlWebService(WEBSERVICE.CHECKOUTPROCESS, {\n        action: getDatasetValue(formBody, 'action'),\n        currentstep: getDatasetValue(formBody, 'currentstep'),\n        identifier: getDatasetValue(formBody, 'identifier'),\n        changedinput: JSON.stringify({\n            'vatCodeCountry': `${countryCode},${vatNumber}`,\n        }),\n    });\n}\n\n/**\n * Initializes the change listener for the form body.\n */\nfunction initControlListener() {\n    const selectors = `${SELECTORS.BUTTONS}, ${SELECTORS.PROGRESSBUTTONS}`;\n    document.querySelectorAll(selectors).forEach(button => {\n        button.addEventListener('click', controlCallback);\n    });\n}\n\n/**\n * Initializes the change listener for the form body.\n */\nfunction controlCallback() {\n    const action = this.getAttribute('data-action');\n    const currentstep = this.getAttribute('data-currentstep');\n    if (action && currentstep) {\n        triggerButtonControlWebService(WEBSERVICE.CHECKOUTPROCESS, {\n            action: action,\n            currentstep: currentstep,\n        });\n    }\n}\n\n/**\n * Initializes the change listener for the form body.\n */\nfunction initChangeListener() {\n    const formBody = document.querySelector(SELECTORS.CHECKBOXITEMBODY);\n    formBody.addEventListener('change', event => changeCallback(event, formBody));\n}\n\n/**\n * Initializes the change listener for the form body.\n * @param {Object} event - The name of the web service.\n * @param {HTMLElement} formBody - The parameters for the web service call.\n */\nfunction changeCallback(event, formBody) {\n    const target = event.target;\n    if (['INPUT', 'SELECT', 'TEXTAREA'].includes(target.tagName)) {\n        const changedInputs = getChangedInputs();\n        if (\n            target.hasAttribute('data-skip-webservice')\n        ) {\n            return;\n        }\n        if (target.type == 'checkbox') {\n            target.value = target.checked;\n        }\n\n        triggerButtonControlWebService(WEBSERVICE.CHECKOUTPROCESS, {\n            action: getDatasetValue(formBody, 'action'),\n            currentstep: getDatasetValue(formBody, 'currentstep'),\n            identifier: getDatasetValue(formBody, 'identifier'),\n            changedinput: JSON.stringify(changedInputs)\n        });\n    }\n}\n\n/**\n * Handles button control for the checkout process.\n */\nfunction getChangedInputs() {\n    const processElements = document.querySelectorAll('[data-shopping-cart-process-data=\"true\"]');\n    return Array.from(processElements).map(element => {\n        const value = element.type === 'checkbox' ? element.checked : element.value;\n        if (element.type === 'radio') {\n            return element.checked\n                ? {name: element.name || 'unnamed', value: value}\n                : [];\n        }\n\n        return {\n            name: element.name || 'unnamed',\n            value: value,\n        };\n    })\n    .filter(item => item !== null);\n}\n\n\n/**\n * Handles button control for the checkout process.\n * @param {string} serviceName - The name of the web service.\n * @param {Object} params - The parameters for the web service call.\n */\nfunction triggerButtonControlWebService(serviceName, params) {\n    require(['core/ajax'], function(Ajax) {\n        const requests = Ajax.call([{\n            methodname: serviceName,\n            args: params,\n        }]);\n        requests[0].done(function(response) {\n            updateCheckoutManagerPartials(response);\n        }).fail(function(err) {\n            // eslint-disable-next-line no-console\n            console.error('fail button trigger', err);\n            return;\n        });\n    });\n}\n\n/**\n * Updates specific Mustache partials dynamically based on the web service response.\n * @param {Object} data - The data returned from the web service.\n */\nfunction updateCheckoutManagerPartials(data) {\n    data.data = JSON.parse(data.data);\n    require(['core/templates'], function(templates) {\n        if (data.reloadbody) {\n            staticReloadBody(templates, data);\n        } else {\n            newReloadBody(templates, data);\n        }\n    });\n}\n\n/**\n * Utility to get dataset values safely.\n * @param {Object} templates - The element with the dataset.\n * @param {Array} data - The element with the dataset.\n */\nfunction newReloadBody(templates, data) {\n    const controlButtons = document.getElementById(SELECTORS.CHECKOUTMANAGERBUTTONSID);\n    const progressBar = document.getElementById(SELECTORS.CHECKOUTMANAGERPROGRESSBARID);\n    const feedbackMessageContainer = document.querySelector(SELECTORS.FEEDBACKMESSAGE);\n\n    if (!controlButtons) {\n        // eslint-disable-next-line no-console\n        console.error('controlButtons');\n        return;\n    }\n    // Render new content for the div\n    const renderButtonTemplate = templates.render(SELECTORS.CHECKOUTMANAGERBUTTONSTEMPLATE, data.data)\n        .then(function(html) {\n            controlButtons.innerHTML = html;\n            return;\n        })\n        .catch(function(err) {\n            // eslint-disable-next-line no-console\n            console.error('fail render button', err);\n        });\n    const progressBarTemplate = templates.render(SELECTORS.CHECKOUTMANAGERPROGRESSBARTEMPLATE, data.data)\n        .then(function(html) {\n            progressBar.innerHTML = html;\n            return;\n        })\n        .catch(function(err) {\n            // eslint-disable-next-line no-console\n            console.error('fail render button', err);\n        });\n    if (feedbackMessageContainer) {\n        const datafeedback = JSON.parse(data.managerdata);\n        if (\n            feedbackMessageContainer &&\n            datafeedback.feedback != undefined\n        ) {\n            templates.render('local_shopping_cart/checkout_manager_feedback', datafeedback.feedback)\n                .then(function(html) {\n                    feedbackMessageContainer.innerHTML = html;\n                    return;\n                })\n                .catch(function(err) {\n                    // eslint-disable-next-line no-console\n                    console.error('fail render feedback', err);\n                });\n        }\n    }\n    Promise.all([renderButtonTemplate, progressBarTemplate]).then(function() {\n        initControlListener();\n        callZeroPriceListener();\n        return;\n    }).catch(function(err) {\n        // eslint-disable-next-line no-console\n        console.error('fail init listener', err);\n    });\n}\n\n/**\n * Utility to get dataset values safely.\n * @param {Object} templates - The element with the dataset.\n * @param {Array} data - The element with the dataset.\n */\nfunction staticReloadBody(templates, data) {\n    templates.render(SELECTORS.CHECKOUTMANAGERFORMTEMPLATE, data.data)\n        .then(function(html, js) {\n            return templates.replaceNodeContents(document.querySelector(SELECTORS.CHECKOUTMANAGERFORMID), html, js);\n        })\n        .then(function() {\n            if (data.jsscript) {\n                const scriptContent = data.jsscript.replace(/<script[^>]*>|<\\/script>/gi, '');\n                try {\n                    templates.appendNodeContents(\n                        document.querySelector(SELECTORS.CHECKOUTMANAGERFORMID),\n                        '',\n                        scriptContent\n                );\n\n                } catch (err) {\n                    // eslint-disable-next-line no-console\n                    console.error('fail script', err);\n                }\n\n                callZeroPriceListener();\n            }\n            return;\n        })\n        .catch(function(err) {\n            // eslint-disable-next-line no-console\n            console.error('fail script', err);\n            return;\n        });\n}\n\n/**\n * Utility to get dataset values safely.\n * @param {HTMLElement} element - The element with the dataset.\n * @param {string} key - The dataset key.\n * @returns {string|null} - The value or null if not found.\n */\nfunction getDatasetValue(element, key) {\n    return element?.dataset[key] || '';\n}\n\nexport {\n    init,\n    getDatasetValue,\n    getChangedInputs\n};\n\n/**\n * Call the zero price listener.\n *\n * @return [type]\n *\n */\nfunction callZeroPriceListener() {\n    // Initially, we need to add the zeroPriceListener once.\n    const paymentbutton = document.querySelector(SELECTORS.PAYMENTREGIONBUTTON);\n    if (paymentbutton) {\n        reinit();\n    }\n}"],"names":["e","formBody","initControlListener","undefined","document","querySelector","SELECTORS","CHECKBOXITEMBODY","addEventListener","event","target","includes","tagName","changedInputs","getChangedInputs","hasAttribute","type","value","checked","triggerButtonControlWebService","WEBSERVICE","CHECKOUTPROCESS","action","getDatasetValue","currentstep","identifier","changedinput","JSON","stringify","changeCallback","initChangeListener","vatNumber","getElementById","IDS","VERIFYVAT","vatNumberVerifyCallback","initVatNumberVerifyListener","initListeners","EVENTSLISTENING","ADDRESSREDRAWN","getNewAddress","_modal_factory","__esModule","default","CHECKOUTMANAGERFORMID","CHECKOUTMANAGERFORMTEMPLATE","CHECKOUTMANAGERBUTTONSTEMPLATE","CHECKOUTMANAGERBUTTONSID","CHECKOUTMANAGERPROGRESSBARTEMPLATE","CHECKOUTMANAGERPROGRESSBARID","BUTTONS","PROGRESSBUTTONS","NEWADDRESSBUTTON","FEEDBACKMESSAGE","PAYMENTREGIONBUTTON","VATNUMBER","COUNTRYSELECT","countryCode","vatCodeCountry","ModalFactory","create","types","CANCEL","then","modal","setTitle","getString","setBody","show","catch","console","log","selectors","querySelectorAll","forEach","button","controlCallback","this","getAttribute","processElements","Array","from","map","element","name","filter","item","serviceName","params","require","Ajax","call","methodname","args","done","response","data","parse","templates","reloadbody","render","html","js","replaceNodeContents","jsscript","scriptContent","replace","appendNodeContents","err","error","callZeroPriceListener","staticReloadBody","controlButtons","progressBar","feedbackMessageContainer","renderButtonTemplate","innerHTML","progressBarTemplate","datafeedback","managerdata","feedback","Promise","all","newReloadBody","fail","key","dataset","reinit"],"mappings":"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"}