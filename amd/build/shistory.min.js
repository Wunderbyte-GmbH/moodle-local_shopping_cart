define("local_shopping_cart/shistory",["exports","core/ajax","core/templates","local_shopping_cart/cart","core/str","local_shopping_cart/notifications","core/modal_factory","core/modal_events","core_form/modalform"],(function(_exports,_ajax,_templates,_cart,_str,_notifications,_modal_factory,_modal_events,_modalform){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.cancelPurchase=cancelPurchase,_exports.confirmCancelModal=confirmCancelModal,_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_modalform=_interopRequireDefault(_modalform);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const SELECTORS_CANCELBUTTON=".cashier-history-items .shopping_cart_history_cancel_button",SELECTORS_PAIDBACKBUTTON="button.shopping_cart_history_paidback_button",SELECTORS_CREDITSMANAGER="button.shopping_cart_history_creditsmanager",SELECTORS_REBOOKBUTTON=".shopping_cart_history_rebook_button";let creditsmanagersuccess="success",notenoughcredits="notenoughcredits";(async()=>{creditsmanagersuccess=await(0,_str.get_string)("creditsmanagersuccess","local_shopping_cart"),notenoughcredits=await(0,_str.get_string)("notenoughcredits","local_shopping_cart")})();const init=function(){let cancelationFee=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const buttons=document.querySelectorAll(SELECTORS_CANCELBUTTON);buttons.forEach((button=>{button.dataset.initialized||(1==button.dataset.canceled?setButtonToCanceled(button):button.addEventListener("click",(event=>{event.preventDefault(),event.stopPropagation(),0==button.dataset.canceled&&(window.location.href.includes("cashier.php")?confirmCancelAndSetCreditModal(button):confirmCancelModal(button,cancelationFee))})),button.dataset.initialized=!0)}));const elements=document.querySelectorAll(SELECTORS_PAIDBACKBUTTON);elements.forEach((element=>{element.dataset.initialized||(element.addEventListener("click",(event=>{event.preventDefault(),event.stopPropagation(),confirmPaidBackModal(element)})),element.dataset.initialized=!0)}));const creditsmanagerbtn=document.querySelectorAll(SELECTORS_CREDITSMANAGER);creditsmanagerbtn.forEach((btn=>{btn.dataset.initialized||(btn.addEventListener("click",(event=>{event.preventDefault(),event.stopPropagation(),openCreditsManagerModal(btn)})),btn.dataset.initialized=!0)}));const rebookbuttons=document.querySelectorAll(SELECTORS_REBOOKBUTTON);rebookbuttons.forEach((btn=>{btn.dataset.initialized||(btn.addEventListener("click",(event=>{event.preventDefault(),event.stopPropagation(),markforrebooking(btn)})),btn.dataset.initialized=!0)}))};function cancelPurchase(itemid,area,userid,componentname,historyid,currency,price,credit,button){_ajax.default.call([{methodname:"local_shopping_cart_cancel_purchase",args:{itemid:itemid,componentname:componentname,area:area,userid:userid,historyid:historyid,credit:credit},done:function(data){if(1==data.success){if((0,_str.get_string)("cancelsuccess","local_shopping_cart").then((message=>{(0,_notifications.showNotification)(message,"success")})).catch((e=>{console.log(e)})),!button)return void("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["local_wunderbyte_table/reload"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("local_wunderbyte_table/reload")):Promise.resolve(_systemImportTransformerGlobalIdentifier["local_wunderbyte_table/reload"])).then((wbt=>{wbt.reloadAllTables()})).catch((err=>{console.log(err)}));setButtonToCanceled(button),function(credit,currency,userid){let creditelement=document.querySelector("li.shopping_cart_history_paidback");if(creditelement){creditelement.classList.remove("hidden"),creditelement.querySelector("span.credit_total").textContent=credit}else{let data={currency:currency,credit:Number(credit).toFixed(2),userid:userid};_templates.default.renderForPromise("local_shopping_cart/credit_item",data).then((_ref2=>{let{html:html}=_ref2;return document.querySelector("ul.cashier-history-items").insertAdjacentHTML("afterbegin",html),init(),!0})).catch((e=>{console.log(e)}))}(0,_cart.updateTotalPrice)()}(data.credit,currency,userid);const addtocartbutton=document.querySelector("#btn-"+componentname+"-"+itemid);addtocartbutton?(addtocartbutton.classList.remove("disabled"),addtocartbutton.dataset.initialized=!1,(0,_cart.buttoninit)(itemid,componentname)):(data.itemid=itemid,data.componentname=componentname,data.price=Number(price).toFixed(2),_templates.default.renderForPromise("local_shopping_cart/addtocartdb",data).then((_ref=>{let{html:html}=_ref,parent=document.querySelector("span.price_"+componentname+"_"+itemid);return parent.textContent=price+" "+currency,parent&&parent.insertAdjacentHTML("beforeend",html),(0,_cart.buttoninit)(itemid,componentname),!0})).catch((e=>{console.log(e)})))}else(0,_str.get_string)("canceldidntwork","local_shopping_cart").then((message=>{(0,_notifications.showNotification)(message,"danger")})).catch((e=>{console.log(e)}))},fail:function(ex){console.log("ex:"+ex)}}])}function setButtonToCanceled(button){button.classList.add("disabled"),button.classList.remove("btn-primary"),button.classList.add("btn-danger"),button.dataset.canceled=!0,(0,_str.get_string)("canceled","local_shopping_cart").then((result=>{button.innerText=result})).catch((e=>{console.log(e)}))}async function confirmCancelModal(button,cancelationFee){if(console.log(button),button.dataset.hasOwnProperty("price")||await new Promise((function(resolve,reject){_ajax.default.call([{methodname:"local_shopping_cart_get_history_item",args:{itemid:button.dataset.itemid,componentname:button.dataset.componentname,area:button.dataset.area,userid:button.dataset.userid},done:function(data){console.log(data),1!=!data.success?(button.dataset.historyid=data.id,button.dataset.price=data.price,button.dataset.credit=0,button.dataset.currency=data.currency,button.dataset.quotaconsumed=data.quotaconsumed,button.dataset.round=data.round,cancelationFee=data.cancelationfee,button.dataset.buttontonull=!0,resolve(data)):resolve(data)},fail:ex=>{console.log("failed to load information for modal: "+JSON.stringify(ex)),reject(ex)}}])})),!button.dataset.hasOwnProperty("price"))return void(0,_str.get_string)("canceldidntwork","local_shopping_cart").then((message=>{(0,_notifications.showNotification)(message,"danger")})).catch((e=>{console.log(e)}));null===cancelationFee&&(cancelationFee=0);const price=parseFloat(button.dataset.price),quotaconsumed=parseFloat(button.dataset.quotaconsumed),deducedvalue=price*quotaconsumed,credit=price-deducedvalue-cancelationFee,currency=button.dataset.currency,percentage=Math.round(100*quotaconsumed),params={quotaconsumed:quotaconsumed.toFixed(2),percentage:percentage+"%",currency:currency,deducedvalue:deducedvalue};button.dataset.round?(params.price=Math.round(price),params.credit=Math.round(credit),params.cancelationfee=Math.round(cancelationFee),params.deducedvalue=Math.round(deducedvalue)):(params.price=price.toFixed(2),params.credit=credit.toFixed(2),params.cancelationfee=cancelationFee.toFixed(2),params.deducedvalue=deducedvalue.toFixed(2));let bodystring="confirmcancelbodyuser";quotaconsumed>0&&quotaconsumed<1?bodystring="confirmcancelbodyuserconsumption":1==quotaconsumed&&(bodystring="confirmcancelbodyusernocredit"),params.credit<0&&(params.cancelationFee=0-params.credit,params.credit=0),console.log(params),(0,_str.get_strings)([{key:"confirmcanceltitle",component:"local_shopping_cart"},{key:bodystring,component:"local_shopping_cart",param:params},{key:"cancelpurchase",component:"local_shopping_cart"}]).then((strings=>(_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL}).then((modal=>(modal.setTitle(strings[0]),modal.setBody(strings[1]),modal.setSaveButtonText(strings[2]),modal.getRoot().on(_modal_events.default.save,(function(){const historyid=button.dataset.historyid,itemid=button.dataset.itemid,userid=button.dataset.userid,currency=button.dataset.currency,componentname=button.dataset.componentname,area=button.dataset.area,price=button.dataset.price;button.dataset.buttontonull&&(button=null),cancelPurchase(itemid,area,userid,componentname,historyid,currency,price,0,button)})),modal.show(),modal))).catch((e=>{console.log(e)})),!0))).catch((e=>{console.log(e)}))}function confirmCancelAndSetCreditModal(button){const price=button.dataset.price,historyid=button.dataset.historyid,itemid=button.dataset.itemid,userid=button.dataset.userid,currency=button.dataset.currency,componentname=button.dataset.componentname,area=button.dataset.area,modalForm=new _modalform.default({formClass:"local_shopping_cart\\form\\modal_cancel_addcredit",args:{price:price,historyid:historyid,itemid:itemid,userid:userid,currency:currency,componentname:componentname,area:area},modalConfig:{title:(0,_str.get_string)("confirmcanceltitle","local_shopping_cart")},returnFocus:button});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(e=>{const response=e.detail;console.log(response);const url=new URL(window.location.href);url.searchParams.append("userid",userid),window.location.replace(url.toString())})),modalForm.show()}function confirmPaidBackModal(element){(0,_str.get_strings)([{key:"confirmpaidbacktitle",component:"local_shopping_cart"},{key:"confirmpaidbackbody",component:"local_shopping_cart"},{key:"confirmpaidback",component:"local_shopping_cart"}]).then((strings=>(_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL}).then((modal=>(modal.setTitle(strings[0]),modal.setBody(strings[1]),modal.setSaveButtonText(strings[2]),modal.getRoot().on(_modal_events.default.save,(function(){!function(element){const userid=element.dataset.userid,method=element.dataset.method;_ajax.default.call([{methodname:"local_shopping_cart_credit_paid_back",args:{userid:userid,method:method},done:function(data){console.log(data),document.querySelector(".credit_total").textContent=0,document.querySelectorAll(".shopping_cart_history_paidback").forEach((licreditelement=>licreditelement.classList.add("hidden"))),(0,_str.get_string)("creditpaidback","local_shopping_cart").then((message=>{(0,_notifications.showNotification)(message,"success")})).catch((e=>{console.log(e)})),(0,_cart.updateTotalPrice)()},fail:function(ex){console.log("ex:"+ex)}}])}(element)})),modal.show(),modal))).catch((e=>{console.log(e)})),!0))).catch((e=>{console.log(e)}))}function openCreditsManagerModal(button){console.log("credits-managermodal");const modalForm=new _modalform.default({formClass:"local_shopping_cart\\form\\modal_creditsmanager",args:{userid:button.dataset.userid},modalConfig:{title:(0,_str.get_string)("creditsmanager","local_shopping_cart")},returnFocus:button});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(e=>{const response=e.detail;response.error&&"notenoughcredits"==response.error?(0,_notifications.showNotification)(notenoughcredits,"danger"):(console.log("credits-manager-modal response: ",response),(0,_notifications.showNotification)(creditsmanagersuccess,"info"),setTimeout((function(){!function(userid){const url=new URL(window.location.href);url.searchParams.delete("userid"),url.searchParams.append("userid",userid),window.location.href=url.toString()}(e.detail.userid)}),1500))})),modalForm.show()}function markforrebooking(button){console.log(button);const historyid=button.dataset.historyid,userid=button.dataset.userid;_ajax.default.call([{methodname:"local_shopping_cart_mark_item_for_rebooking",args:{historyid:historyid,userid:userid},done:function(data){console.log(data),window.location.reload()},fail:ex=>{console.log("local_shopping_cart_mark_item_for_rebooking failed: "+JSON.stringify(ex))}}])}_exports.init=init}));

//# sourceMappingURL=shistory.min.js.map