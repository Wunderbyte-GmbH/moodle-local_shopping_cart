define("local_shopping_cart/shistory",["exports","core/ajax","core/templates","local_shopping_cart/cart","core/str","local_shopping_cart/notifications","core/modal_factory","core/modal_events","core_form/modalform"],(function(_exports,_ajax,_templates,_cart,_str,_notifications,_modal_factory,_modal_events,_modalform){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * @package    local_shopping_cart
   * @copyright  Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_modalform=_interopRequireDefault(_modalform);var init=function(){var cancelationFee=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,buttons=document.querySelectorAll(".cashier-history-items .shopping_cart_history_cancel_button");buttons.forEach((function(button){button.dataset.initialized||(1==button.dataset.canceled?setButtonToCanceled(button):button.addEventListener("click",(function(event){event.preventDefault(),event.stopPropagation(),0==button.dataset.canceled&&(window.location.href.includes("cashier.php")?confirmCancelAndSetCreditModal(button):confirmCancelModal(button,cancelationFee))})),button.dataset.initialized=!0)}));var elements=document.querySelectorAll("button.shopping_cart_history_paidback_button");elements.forEach((function(element){element.dataset.initialized||(element.addEventListener("click",(function(event){event.preventDefault(),event.stopPropagation(),confirmPaidBackModal(element)})),element.dataset.initialized=!0)}))};function cancelPurchase(itemid,area,userid,componentname,historyid,currency,price,credit,button){_ajax.default.call([{methodname:"local_shopping_cart_cancel_purchase",args:{itemid:itemid,componentname:componentname,area:area,userid:userid,historyid:historyid,credit:credit},done:function(data){if(1==data.success){(0,_str.get_string)("cancelsuccess","local_shopping_cart").then((function(message){(0,_notifications.showNotification)(message,"success")})).catch((function(e){console.log(e)})),setButtonToCanceled(button),function(credit,currency,userid){var creditelement=document.querySelector("li.shopping_cart_history_paidback");if(creditelement){creditelement.classList.remove("hidden"),creditelement.querySelector("span.credit_total").textContent=credit}else{var data={currency:currency,credit:credit,userid:userid};_templates.default.renderForPromise("local_shopping_cart/credit_item",data).then((function(_ref2){var html=_ref2.html;return document.querySelector("ul.cashier-history-items").insertAdjacentHTML("afterbegin",html),init(),!0})).catch((function(e){console.log(e)}))}(0,_cart.updateTotalPrice)()}(data.credit,currency,userid);var addtocartbutton=document.querySelector("#btn-"+componentname+"-"+itemid);addtocartbutton?(addtocartbutton.classList.remove("disabled"),addtocartbutton.dataset.initialized=!1,(0,_cart.buttoninit)(itemid,componentname)):(data.itemid=itemid,data.componentname=componentname,data.price=price,_templates.default.renderForPromise("local_shopping_cart/addtocartdb",data).then((function(_ref){var html=_ref.html,parent=document.querySelector("span.price_"+componentname+"_"+itemid);return parent.textContent=price+" "+currency,parent&&parent.insertAdjacentHTML("beforeend",html),(0,_cart.buttoninit)(itemid,componentname),!0})).catch((function(e){console.log(e)})))}else(0,_str.get_string)("canceldidntwork","local_shopping_cart").then((function(message){(0,_notifications.showNotification)(message,"danger")})).catch((function(e){console.log(e)}))},fail:function(ex){console.log("ex:"+ex)}}])}function setButtonToCanceled(button){button.classList.add("disabled"),button.classList.remove("btn-primary"),button.classList.add("btn-danger"),button.dataset.canceled=!0,(0,_str.get_string)("canceled","local_shopping_cart").then((function(result){button.innerText=result})).catch((function(e){console.log(e)}))}function confirmCancelModal(button,cancelationFee){null===cancelationFee&&(cancelationFee=0);var price=parseFloat(button.dataset.price),quotaconsumed=parseFloat(button.dataset.quotaconsumed),credit=price-price*quotaconsumed-cancelationFee,currency=button.dataset.currency,percentage=Math.round(100*quotaconsumed),params={quotaconsumed:quotaconsumed.toFixed(2),percentage:percentage+"%",currency:currency};button.dataset.round?(params.price=Math.round(price),params.credit=Math.round(credit),params.cancelationfee=Math.round(cancelationFee)):(params.price=price.toFixed(2),params.credit=credit.toFixed(2),params.cancelationfee=cancelationFee.toFixed(2));var bodystring="confirmcancelbodyuser";quotaconsumed>0&&quotaconsumed<1?bodystring="confirmcancelbodyuserconsumption":1==quotaconsumed&&(bodystring="confirmcancelbodyusernocredit"),params.credit<0&&(params.cancelationFee=0-params.credit,params.credit=0),console.log(params),(0,_str.get_strings)([{key:"confirmcanceltitle",component:"local_shopping_cart"},{key:bodystring,component:"local_shopping_cart",param:params},{key:"cancelpurchase",component:"local_shopping_cart"}]).then((function(strings){return _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL}).then((function(modal){return modal.setTitle(strings[0]),modal.setBody(strings[1]),modal.setSaveButtonText(strings[2]),modal.getRoot().on(_modal_events.default.save,(function(){var historyid=button.dataset.historyid,itemid=button.dataset.itemid,userid=button.dataset.userid,currency=button.dataset.currency,componentname=button.dataset.componentname;cancelPurchase(itemid,button.dataset.area,userid,componentname,historyid,currency,button.dataset.price,0,button)})),modal.show(),modal})).catch((function(e){console.log(e)})),!0})).catch((function(e){console.log(e)}))}function confirmCancelAndSetCreditModal(button){var price=button.dataset.price,historyid=button.dataset.historyid,itemid=button.dataset.itemid,userid=button.dataset.userid,currency=button.dataset.currency,componentname=button.dataset.componentname,area=button.dataset.area,modalForm=new _modalform.default({formClass:"local_shopping_cart\\form\\modal_cancel_addcredit",args:{price:price,historyid:historyid,itemid:itemid,userid:userid,currency:currency,componentname:componentname,area:area},modalConfig:{title:(0,_str.get_string)("confirmcanceltitle","local_shopping_cart")},returnFocus:button});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(function(e){var response=e.detail;console.log(response),window.location.reload()})),modalForm.show()}function confirmPaidBackModal(element){(0,_str.get_strings)([{key:"confirmpaidbacktitle",component:"local_shopping_cart"},{key:"confirmpaidbackbody",component:"local_shopping_cart"},{key:"confirmpaidback",component:"local_shopping_cart"}]).then((function(strings){return _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL}).then((function(modal){return modal.setTitle(strings[0]),modal.setBody(strings[1]),modal.setSaveButtonText(strings[2]),modal.getRoot().on(_modal_events.default.save,(function(){!function(element){var userid=element.dataset.userid;_ajax.default.call([{methodname:"local_shopping_cart_credit_paid_back",args:{userid:userid},done:function(data){console.log(data),document.querySelector(".credit_total").textContent=0,document.querySelector(".shopping_cart_history_paidback").classList.add("hidden"),(0,_str.get_string)("creditpaidback","local_shopping_cart").then((function(message){(0,_notifications.showNotification)(message,"success")})).catch((function(e){console.log(e)})),(0,_cart.updateTotalPrice)()},fail:function(ex){console.log("ex:"+ex)}}])}(element)})),modal.show(),modal})).catch((function(e){console.log(e)})),!0})).catch((function(e){console.log(e)}))}_exports.init=init}));

//# sourceMappingURL=shistory.min.js.map