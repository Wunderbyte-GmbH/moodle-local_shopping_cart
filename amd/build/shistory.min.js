define("local_shopping_cart/shistory",["exports","core/ajax","core/templates","local_shopping_cart/cart","core/str","core/notification","core/modal_factory","core/modal_events","core_form/modalform"],(function(_exports,_ajax,_templates,_cart,_str,_notification,_modal_factory,_modal_events,_modalform){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * @package    local_shopping_cart
   * @copyright  Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_modalform=_interopRequireDefault(_modalform);const init=()=>{document.querySelectorAll("#shopping_cart-cashiers-section .shopping_cart_history_cancel_button").forEach((button=>{button.dataset.initialized||(1==button.dataset.canceled?setButtonToCanceled(button):button.addEventListener("click",(event=>{event.preventDefault(),event.stopPropagation(),0==button.dataset.canceled&&(console.log("button clicked"),function(button){const price=button.dataset.price,modalForm=new _modalform.default({formClass:"local_shopping_cart\\form\\modal_cancel_addcredit",args:{credit:price},modalConfig:{title:(0,_str.get_string)("confirmcanceltitle","local_shopping_cart")},returnFocus:button});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(e=>{var _e$detail$credit;window.console.log(e.detail);const historyid=button.dataset.historyid,itemid=button.dataset.itemid,userid=button.dataset.userid,currency=button.dataset.currency,componentname=button.dataset.componentname,credit=null!==(_e$detail$credit=e.detail.credit)&&void 0!==_e$detail$credit?_e$detail$credit:"";!function(itemid,userid,componentname,historyid,currency,price,credit,button){console.log("button clicked",historyid),_ajax.default.call([{methodname:"local_shopping_cart_cancel_purchase",args:{itemid:itemid,componentname:componentname,userid:userid,historyid:historyid,credit:credit},done:function(data){if(console.log(data),1==data.success){(0,_str.get_string)("cancelsuccess","local_shopping_cart").then((message=>{_notification.default.addNotification({message:message,type:"success"}),setTimeout((()=>{let notificationslist=document.querySelectorAll("#user-notifications div.alert");notificationslist[notificationslist.length-1].remove()}),5e3)})).catch((e=>{console.log(e)})),console.log("data returned",data.success),setButtonToCanceled(button),function(credit,currency,userid){let creditelement=document.querySelector("li.shopping_cart_history_paidback");if(creditelement){creditelement.classList.remove("hidden"),creditelement.querySelector("span.credit_total").textContent=credit}else{let data={currency:currency,credit:credit,userid:userid};_templates.default.renderForPromise("local_shopping_cart/credit_item",data).then((_ref2=>{let{html:html}=_ref2;return document.querySelector("ul.cashier-history-items").insertAdjacentHTML("afterbegin",html),init(),!0})).catch((e=>{console.log(e)}))}(0,_cart.updateTotalPrice)()}(data.credit,currency,userid);const addtocartbutton=document.querySelector("#btn-"+componentname+"-"+itemid);addtocartbutton?(console.log(addtocartbutton),addtocartbutton.classList.remove("disabled"),addtocartbutton.dataset.initialized=!1,(0,_cart.buttoninit)(itemid,componentname)):(data.itemid=itemid,data.componentname=componentname,data.price=price,_templates.default.renderForPromise("local_shopping_cart/addtocartdb",data).then((_ref=>{let{html:html}=_ref,parent=document.querySelector("span.price_"+componentname+"_"+itemid);return parent.textContent=price+" "+currency,parent&&parent.insertAdjacentHTML("beforeend",html),(0,_cart.buttoninit)(itemid,componentname),!0})).catch((e=>{console.log(e)})))}else(0,_str.get_string)("canceldidntwork","local_shopping_cart").then((message=>{_notification.default.addNotification({message:message,type:"danger"}),setTimeout((()=>{let notificationslist=document.querySelectorAll("#user-notifications div.alert");notificationslist[notificationslist.length-1].remove()}),5e3)})).catch((e=>{console.log(e)}))},fail:function(ex){console.log("ex:"+ex)}}])}(itemid,userid,componentname,historyid,currency,price,credit,button)})),modalForm.show()}(button))})),button.dataset.initialized=!0)}));document.querySelectorAll("button.shopping_cart_history_paidback_button").forEach((element=>{console.log("initialize paid back",element),element.dataset.initialized||(element.addEventListener("click",(event=>{event.preventDefault(),event.stopPropagation(),console.log("button clicked"),function(element){(0,_str.get_strings)([{key:"confirmpaidbacktitle",component:"local_shopping_cart"},{key:"confirmpaidbackbody",component:"local_shopping_cart"},{key:"confirmpaidback",component:"local_shopping_cart"}]).then((strings=>(_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL}).then((modal=>(modal.setTitle(strings[0]),modal.setBody(strings[1]),modal.setSaveButtonText(strings[2]),modal.getRoot().on(_modal_events.default.save,(function(){console.log("we saved"),function(element){const userid=element.dataset.userid;_ajax.default.call([{methodname:"local_shopping_cart_credit_paid_back",args:{userid:userid},done:function(data){console.log(data,userid),document.querySelector(".credit_total").textContent=0,document.querySelector(".shopping_cart_history_paidback").classList.add("hidden"),_notification.default.addNotification({message:"Credit paid back",type:"success"}),setTimeout((()=>{let notificationslist=document.querySelectorAll("#user-notifications div.alert.alert-success");notificationslist[notificationslist.length-1].remove()}),5e3),(0,_cart.updateTotalPrice)()},fail:function(ex){console.log("ex:"+ex)}}])}(element)})),modal.show(),modal))).catch((e=>{console.log(e)})),!0))).catch((e=>{console.log(e)}))}(element)})),element.dataset.initialized=!0)}))};function setButtonToCanceled(button){button.classList.add("disabled"),button.classList.remove("btn-primary"),button.classList.add("btn-danger"),button.dataset.canceled=!0,(0,_str.get_string)("canceled","local_shopping_cart").then((result=>{console.log(result),button.innerText=result})).catch((e=>{console.log(e)}))}_exports.init=init}));

//# sourceMappingURL=shistory.min.js.map